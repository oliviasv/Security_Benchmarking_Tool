#
# This script is Copyright (C) 2004-2020 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
# $Revision: 1.6 $
# $Date: 2020/04/22 $
#
# Description : This .audit is based on the CIS Palo Alto Firewall 7 Benchmark v1.0.0, 03-31-2017
#               https://workbench.cisecurity.org/files/1664
#
#<ui_metadata>
#<display_name>CIS Palo Alto Firewall 7 Benchmark L2 v1.0.0</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Palo Alto Firewall 7 L2</name>
#  <version>1.0.0</version>
#</spec>
#<labels>palo_alto,cis,panos,pan</labels>
#<benchmark_refs>LEVEL,CSCv6</benchmark_refs>
#</ui_metadata>

<check_type:"Palo_Alto">

<if>
  <condition type:"AND">
    <custom_item>
      type             : AUDIT_XML
      description      : "Check for Palo Alto version 7+"
      api_request_type : "op"
      request          : "<show><system><info></info></system></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:value-of select=\"/response/result/system/sw-version\"/>"
      regex            : ".*"
      expect           : "^[\s]*7\..*"
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type             : AUDIT_XML
      description      : "1.2.4 Ensure valid certificate is set for browser-based administrator interface - Certificates"
      info             : "In most cases, a browser HTTPS interface is used to administer the Palo Alto appliance. The certificate used to secure this session should satisfy the following criteria:
    1. A valid certificate from a trusted source should be used. While a certificate from a trusted Public Certificate Authority is certainly valid, one from a trusted Private Certificate Authority is absolutely acceptable for this purpose.
    2. The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    3. The certificate should use an acceptable cipher and encryption level.
    Rationale:
    If a certificate that is self-signed, expired, or otherwise invalid is used for the browser HTTPS interface, administrators in most cases will not be able to tell if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "If a new administrative certificate is needed, acquire a certificate that meets the stated criteria and set it:
    Navigate to Device > Certificate Management > Certificates
    Set an appropriately named Certificate Profile for Management Interface Access:
    Navigate to Device > Certificate Management > Certificate Profile
    Set the Authentication Profile field so it contains the Certificate Profile created for Management Interface Access:
    Navigate to Device > Setup > Management (tab) > Authentication Settings > Authentication Profile (field)
    Default Value:
    A self-signed certificate is installed by default for the administrative interface."
      reference        : "800-53|SC-17,CSCv6|14.2,CSCv6|16.13,CSCv6|3.4,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/shared/certificate/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/shared/certificate/entry\">"
      xsl_stmt         : "Certificate name: <xsl:value-of select=\"@name\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No certificates found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "1.2.4 Ensure valid certificate is set for browser-based administrator interface - Certificate Profiles"
      info             : "In most cases, a browser HTTPS interface is used to administer the Palo Alto appliance. The certificate used to secure this session should satisfy the following criteria:
    1. A valid certificate from a trusted source should be used. While a certificate from a trusted Public Certificate Authority is certainly valid, one from a trusted Private Certificate Authority is absolutely acceptable for this purpose.
    2. The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    3. The certificate should use an acceptable cipher and encryption level.
    Rationale:
    If a certificate that is self-signed, expired, or otherwise invalid is used for the browser HTTPS interface, administrators in most cases will not be able to tell if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "If a new administrative certificate is needed, acquire a certificate that meets the stated criteria and set it:
    Navigate to Device > Certificate Management > Certificates
    Set an appropriately named Certificate Profile for Management Interface Access:
    Navigate to Device > Certificate Management > Certificate Profile
    Set the Authentication Profile field so it contains the Certificate Profile created for Management Interface Access:
    Navigate to Device > Setup > Management (tab) > Authentication Settings > Authentication Profile (field)
    Default Value:
    A self-signed certificate is installed by default for the administrative interface."
      reference        : "800-53|SC-17,CSCv6|14.2,CSCv6|16.13,CSCv6|3.4,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/shared/certificate-profile/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/shared/certificate-profile/entry\">"
      xsl_stmt         : "Certificate Profile name: <xsl:value-of select=\"@name\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No certificate profiles found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "1.2.4 Ensure valid certificate is set for browser-based administrator interface - Authentication Profile"
      info             : "In most cases, a browser HTTPS interface is used to administer the Palo Alto appliance. The certificate used to secure this session should satisfy the following criteria:
    1. A valid certificate from a trusted source should be used. While a certificate from a trusted Public Certificate Authority is certainly valid, one from a trusted Private Certificate Authority is absolutely acceptable for this purpose.
    2. The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    3. The certificate should use an acceptable cipher and encryption level.
    Rationale:
    If a certificate that is self-signed, expired, or otherwise invalid is used for the browser HTTPS interface, administrators in most cases will not be able to tell if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "If a new administrative certificate is needed, acquire a certificate that meets the stated criteria and set it:
    Navigate to Device > Certificate Management > Certificates
    Set an appropriately named Certificate Profile for Management Interface Access:
    Navigate to Device > Certificate Management > Certificate Profile
    Set the Authentication Profile field so it contains the Certificate Profile created for Management Interface Access:
    Navigate to Device > Setup > Management (tab) > Authentication Settings > Authentication Profile (field)
    Default Value:
    A self-signed certificate is installed by default for the administrative interface."
      reference        : "800-53|IA-2(12),CSCv6|14.2,CSCv6|16.13,CSCv6|3.4,CSF|PR.AC-1,LEVEL|2NS"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/devices/entry/deviceconfig/system/certificate-profile\">"
      xsl_stmt         : "Authentication Profile: <xsl:value-of select=\"/response/result/config/devices/entry/deviceconfig/system/certificate-profile\"/>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No authentication profile found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "1.6.3 Ensure that the certificate securing Remote Access VPNs is valid - Certificates"
      info             : "The Certificate used to secure Remote Access VPNs should satisfy the following criteria:
    * It should be a valid certificate from a trusted source. In almost cases this means a trusted Public Certificate Authority, as in most cases remote access VPN users will not have access to any Private Certificate Authorities for Certificate validation.
    * The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    * The key length used to encrypt the certificate should be 2048 bits or more.
    * The hash used to sign the certificate should be SHA-2 or better.
    Rationale:
    If presented with a certificate error, the end user in most cases will not be able to tell if their session is using a self-signed or expired certificate, or if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "Create a CSR and install a certificate from a public CA here:
    Navigate to Device > Certificate Management > Certificates
    Apply a valid certificate to the HTTPS portal:
    Navigate to Network > GlobalProtect > Portals > Portal Configuration > Authentication > SSL/TLS Profile
    Apply a valid certificate to the GlobalProtect Gateway:
    Navigate to Network > GlobalProtect > Gateways > Authentication > SSL/TLS Profile
    Default Value:
    Not configured"
      reference        : "800-53|SC-17,CSCv6|14.2,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/shared/certificate/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/shared/certificate/entry\">"
      xsl_stmt         : "Certificate name: <xsl:value-of select=\"@name\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No certificates found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "1.6.3 Ensure that the certificate securing Remote Access VPNs is valid - GlobalProtect Portals"
      info             : "The Certificate used to secure Remote Access VPNs should satisfy the following criteria:
    * It should be a valid certificate from a trusted source. In almost cases this means a trusted Public Certificate Authority, as in most cases remote access VPN users will not have access to any Private Certificate Authorities for Certificate validation.
    * The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    * The key length used to encrypt the certificate should be 2048 bits or more.
    * The hash used to sign the certificate should be SHA-2 or better.
    Rationale:
    If presented with a certificate error, the end user in most cases will not be able to tell if their session is using a self-signed or expired certificate, or if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "Create a CSR and install a certificate from a public CA here:
    Navigate to Device > Certificate Management > Certificates
    Apply a valid certificate to the HTTPS portal:
    Navigate to Network > GlobalProtect > Portals > Portal Configuration > Authentication > SSL/TLS Profile
    Apply a valid certificate to the GlobalProtect Gateway:
    Navigate to Network > GlobalProtect > Gateways > Authentication > SSL/TLS Profile
    Default Value:
    Not configured"
      reference        : "800-53|SC-17,CSCv6|14.2,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/devices/entry/vsys/entry/global-protect/global-protect-portal/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/devices/entry/vsys/entry/global-protect/global-protect-portal/entry\">"
      xsl_stmt         : "GlobalProtect Portal name: <xsl:value-of select=\"@name\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No GlobalProtect Portals found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "1.6.3 Ensure that the certificate securing Remote Access VPNs is valid - GlobalProtect Gateways"
      info             : "The Certificate used to secure Remote Access VPNs should satisfy the following criteria:
    * It should be a valid certificate from a trusted source. In almost cases this means a trusted Public Certificate Authority, as in most cases remote access VPN users will not have access to any Private Certificate Authorities for Certificate validation.
    * The certificate should have a valid date. It should not have a \"to\" date in the past (it should not be expired), and should not have a \"from\" date in the future.
    * The key length used to encrypt the certificate should be 2048 bits or more.
    * The hash used to sign the certificate should be SHA-2 or better.
    Rationale:
    If presented with a certificate error, the end user in most cases will not be able to tell if their session is using a self-signed or expired certificate, or if their session is being eavesdropped on or injected into by a \"Man in the Middle\" attack.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "Create a CSR and install a certificate from a public CA here:
    Navigate to Device > Certificate Management > Certificates
    Apply a valid certificate to the HTTPS portal:
    Navigate to Network > GlobalProtect > Portals > Portal Configuration > Authentication > SSL/TLS Profile
    Apply a valid certificate to the GlobalProtect Gateway:
    Navigate to Network > GlobalProtect > Gateways > Authentication > SSL/TLS Profile
    Default Value:
    Not configured"
      reference        : "800-53|SC-17,CSCv6|14.2,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/devices/entry/vsys/entry/global-protect/global-protect-gateway/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/devices/entry/vsys/entry/global-protect/global-protect-gateway/entry\">"
      xsl_stmt         : "GlobalProtect Gateway name: <xsl:value-of select=\"@name\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No GlobalProtect Gateways found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "2.1 Ensure that IP addresses are mapped to usernames - User ID Agents"
      info             : "Configure appropriate settings to map IP addresses to usernames. Mapping userids to IP addresses is what permits the firewall to create rules based on userids and groups rather than IP addresses and subnets, as well as log events by userids rather than IP addresses or DNS names. The specifics of how to achieve IP-to-username mapping is highly dependent on the environment. It can be enabled by integrating the firewall with a domain controller, Exchange server, captive portal, Terminal Server, User-ID Agent, XML API, or syslog data from a variety of devices.
    Rationale:
    Understanding which user is involved in a security incident allows appropriate personnel to move quickly between the detection and reaction phases of incident response. In environments with either short DHCP lease times, or where users may move frequently between systems, the ability to analyze or report, or alert on events based on user accounts or user groups is a tremendous advantage. For forensics tasks when DHCP lease information may not be available, the Source User information may be the only way to tie together related data.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "To Set User-ID Agents:
    Navigate to Device > User Identification > User-ID Agents
    Set the Name, IP Address and Port of the User-ID Agent
    Enable User Identification for each monitored zone that will have user accounts:
    Navigate to Network > Zone, for each relevant zone enable User Identification
    To Set Terminal Services Agents:
    Navigate to Device > Terminal Services Agents Set the Name, IP Address and Port of the Terminal Services Agent Enable User Identification for each monitored zone that will have Terminal Servers: Navigate to Network > Zone, enable User Identification"
      reference        : "800-171|3.5.5,800-171|3.5.6,800-53|IA-4,CN-L3|7.1.2.7(b),CSCv6|6.5,CSF|PR.AC-1,ITSG-33|IA-4,LEVEL|2S,NESA|T5.5.2,SWIFT-CSCv1|5"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"/response/result/config/devices/entry/vsys/entry/user-id-agent/entry\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/devices/entry/vsys/entry/user-id-agent/entry\">"
      xsl_stmt         : "UserID Agent Name: <xsl:value-of select=\"@name\"/>, Port: <xsl:value-of select=\"port\"/>, Host: <xsl:value-of select=\"host\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "No User ID Agents found"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "2.1 Ensure that IP addresses are mapped to usernames - Zones"
      info             : "Configure appropriate settings to map IP addresses to usernames. Mapping userids to IP addresses is what permits the firewall to create rules based on userids and groups rather than IP addresses and subnets, as well as log events by userids rather than IP addresses or DNS names. The specifics of how to achieve IP-to-username mapping is highly dependent on the environment. It can be enabled by integrating the firewall with a domain controller, Exchange server, captive portal, Terminal Server, User-ID Agent, XML API, or syslog data from a variety of devices.
    Rationale:
    Understanding which user is involved in a security incident allows appropriate personnel to move quickly between the detection and reaction phases of incident response. In environments with either short DHCP lease times, or where users may move frequently between systems, the ability to analyze or report, or alert on events based on user accounts or user groups is a tremendous advantage. For forensics tasks when DHCP lease information may not be available, the Source User information may be the only way to tie together related data.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "To Set User-ID Agents:
    Navigate to Device > User Identification > User-ID Agents
    Set the Name, IP Address and Port of the User-ID Agent
    Enable User Identification for each monitored zone that will have user accounts:
    Navigate to Network > Zone, for each relevant zone enable User Identification
    To Set Terminal Services Agents:
    Navigate to Device > Terminal Services Agents Set the Name, IP Address and Port of the Terminal Services Agent Enable User Identification for each monitored zone that will have Terminal Servers: Navigate to Network > Zone, enable User Identification"
      reference        : "800-171|3.4.2,800-53|CM-6,CN-L3|8.1.10.6(d),CSCv6|6.5,CSF|PR.IP-1,ITSG-33|CM-6,LEVEL|2S,NESA|T3.2.1,PCI-DSSv3.1|2.2.4,PCI-DSSv3.2|2.2.4,SWIFT-CSCv1|2.3"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:for-each select=\"/response/result/config/devices/entry/vsys/entry/zone/entry\">"
      xsl_stmt         : "Zone - <xsl:value-of select=\"@*\"/>, Enable User Identification - <xsl:value-of select=\"enable-user-identification\"/>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "<xsl:if test=\"count(/response/result/config/devices/entry/vsys/entry/zone/entry) = 0\">"
      xsl_stmt         : "No Network Zone Policies found"
      xsl_stmt         : "</xsl:if>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "2.2 Ensure that WMI probing is disabled"
      info             : "Disable WMI probing if it is not required for User-ID functionality in the environment.
    Rationale:
    By default, WMI probing requires a domain administrator account. A malicious user could capture the encrypted password hash for offline cracking or relayed authentication attacks. Relying on other forms of user identification, such as security log monitoring, mitigates this risk."
      solution         : "Navigate to Device > User Identification > User Mapping > Palo Alto Networks User ID Agent Setup > Client Probing.
    Set Enable Probing so it is unchecked.
    Impact:
    While this removes the exposure of having the WMI user account password being compromised, it also reduces the effectiveness of user identification during operation of the firewall (applying rules and policies). This trade-off should be weighed carefully for all installations.
    Default Value:
    Not configured"
      reference        : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CIP|007-6-R1,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSCv6|9.1,CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2S,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,PCI-DSSv3.1|2.2.2,PCI-DSSv3.1|2.2.3,PCI-DSSv3.2|2.2.2,PCI-DSSv3.2|2.2.3,SWIFT-CSCv1|2.3"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"not(//user-id-collector/setting/enable-probing) or (//user-id-collector/setting/enable-probing = 'no')\">"
      xsl_stmt         : "Passed - 'Enable Probing' is turned off"
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "Failed - 'Enable Probing' is turned on"
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      regex            : "(Passed|Failed)"
      expect           : "Passed"
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "6.17 Ensure that a Zone Protection Profile with Flood Protection settings enabled for all flood types is attached to all untrusted zones"
      info             : "Enable all Flood Protection options in the Zone Protection Profile attached to all untrusted zones. The Alert, Activate, and Maximum settings for Flood Protection depend highly on the environment and device used. Perform traffic analysis on the specific environment and firewall to determine accurate thresholds. Do not rely on default values to be appropriate for an environment.
    Rationale:
    Without flood protection, it may be possible for an attacker, through the use of a botnet or other means, to overwhelm network resources. Flood protection does not completely eliminate this risk; rather, it provides a layer of protection. Without a properly configured zone protection profile applied to untrusted interfaces, the protected / trusted networks are susceptible to large number of attacks. While many of these involve denial of service, some of these attacks are designed to evade IPS systems (fragmentation attacks for instance) or to evade basic firewall protections (source routing and record route attacks)."
      solution         : "In the GUI:
    Navigate to Network > Network Profiles > Zone Protection > Flood Protection.
    Set all settings to \"enabled\" with at least the default values.
    Navigate to Network > Zones, select each untrusted zone in turn, and set the Zone Protection Profile.
    Default Value:
    Not Configured"
      reference        : "800-53|SC-5,CSF|DE.CM-1,CSF|PR.DS-4,ITSG-33|SC-5,LEVEL|2S,NESA|T3.3.1,NIAv2|GS10c,NIAv2|GS8e"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "<xsl:for-each select=\"//devices/entry/network/profiles/zone-protection-profile/entry\">"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"flood/icmp/enable='yes'\">"
      xsl_stmt         : "Passed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has ICMP flood protection enabled."
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "Failed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has ICMP flood protection disabled."
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"flood/icmpv6/enable='yes'\">"
      xsl_stmt         : "Passed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has ICMPv6 flood protection enabled."
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "Failed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has ICMPv6 flood protection disabled."
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"flood/other-ip/enable='yes'\">"
      xsl_stmt         : "Passed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has Other IP flood protection enabled."
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "Failed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has Other IP flood protection disabled."
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      xsl_stmt         : "<xsl:choose>"
      xsl_stmt         : "<xsl:when test=\"flood/udp/enable='yes'\">"
      xsl_stmt         : "Passed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has UDP flood protection enabled."
      xsl_stmt         : "</xsl:when>"
      xsl_stmt         : "<xsl:otherwise>"
      xsl_stmt         : "Failed - Zone Protection Profile '<xsl:value-of select=\"@name\"/>' has UDP flood protection disabled."
      xsl_stmt         : "</xsl:otherwise>"
      xsl_stmt         : "</xsl:choose>"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "<xsl:if test=\"count(//devices/entry/network/profiles/zone-protection-profile/entry) = 0\">"
      xsl_stmt         : "Failed - No Zone Protection Profiles found"
      xsl_stmt         : "</xsl:if>"
      regex            : "(Passed|Failed)"
      not_expect       : "Failed"
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "7.3 Ensure 'Security Policy' denying any/all traffic exists at the bottom of the security policies ruleset"
      info             : "EXTREME CAUTION MUST BE USED BEFORE IMPLEMENTING THIS RECOMMENDATION, AS CERTAIN TRAFFIC PERMITTED BY DEFAULT WILL BE DENIED UNLESS SPECIFICALLY ALLOWED. Create a security rule at the bottom of the security policies ruleset denying any traffic, regardless of source, destination, or application. Ensure this policy is set to log at session end, just before pre-defined intrazone-default and interzone-default rules.
    Rationale:
    In incident response, logging denied traffic is often just as important as logging permitted traffic. The logs for denied traffic can be used to establish a pattern of failed attack attempts before the final attack succeeds. This can be used in attribution and identification of the attacker, but can also be used to help identify which defenses need shoring up to defend against future attacks. Viewing denied traffic can also be useful for understanding how security policies are affecting traffic.
    Palo Alto firewalls do not log denied traffic by default. Therefore, to acquire visibility to denied traffic, a 'deny and log' policy must be created at the end of the security policy ruleset.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "Navigate to Policies > Security.
    Set a Security Policy with: Name set to 'Deny and Log Any' Source: Zone set to Any Address set to Any Destination: Zone set to Any Address set to Any Application set to Any Service set to Any Action set to Block Profile set to None
    Default Value:
    Not Configured"
      reference        : "800-171|3.13.1,800-171|3.13.6,800-53|SC-7(5),CN-L3|7.1.2.2(c),CSCv6|6.5,CSF|PR.PT-4,ITSG-33|SC-7(5),LEVEL|2S,NIAv2|GS7b,NIAv2|NS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "Verify deny all traffic exists at bottom of ruleset"
      xsl_stmt         : "<xsl:for-each select=\"//rulebase/security/rules/entry\">"
      xsl_stmt         : "Security policy: '<xsl:value-of select=\"@name\"/>'"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "<xsl:if test=\"count(//rulebase/security/rules/entry) = 0\">"
      xsl_stmt         : "No Security Policies found"
      xsl_stmt         : "</xsl:if>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>

    <custom_item>
      type             : AUDIT_XML
      description      : "8.3 Ensure that the Certificate used for Decryption is Trusted"
      info             : "The CA Certificate used for in-line HTTP Man in the Middle should be trusted by target users. There are two classes of users that need to be considered.
    1: Users that are members of the organization, users of machines under control of the organization. For these people and machines, ensure that the CA Certificate is in one of the Trusted CA certificate stores. This is easily done in Active Directory, using Group Policies for instance. A MDM (Mobile Device Manager) can be used to accomplish the same task for mobile devices such as telephones or tablets. Other central management or orchestration tools can be used for Linux or \"IoT\" (Internet of Things) devices.
    2: Users that are not member of the organization - often these are classed as \"Visitors\" in the policies of the organization. If a public CA Certificate is a possibility for your organization, then that is one approach. A second approach is to not decrypt affected traffic - this is easily done, but leaves the majority of \"visitor\" traffic uninspected and potentially carrying malicious content. The final approach, and the one most commonly seen, is to use the same certificate as is used for members organization. In this last case, visitors will see a certificate warning, but the issuing CA will be the organization that they are visiting.
    Rationale:
    Using a self-signed certificate, or any certificate that generates a warning in the browser, means that members of the organization have no method of determining if they are being presented with a legitimate certificate, or an attacker's \"man in the middle' certificate. It also very rapidly teaches members of the organization to bypass all security warnings of this type.

    NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution         : "Set the CA Certificate(s):
    Navigate to Device > Setup > Certificate Management > Certificates.
    Set the Certificate Profile needed for the SSL Forward Proxy:
    Navigate to Device > Setup > Certificate Management > Certificate Profile.
    Set the decryption profile to include the settings described in the SSL Forward Proxy guidance in this document:
    Navigate to Objects > Decryption Profile.
    Set the Decryption Policy to be applied to the appropriate interfaces and to have the categories assigned to it that comply with your organization's internal policies, regulatory requirements and legal requirements.
    Navigate to Policies > Decryption.
    Source: all internal user subnets.
    Destination: all target zones (typically this is the public internet).
    Excluded URL categories: include Health Care, Personal Banking and any other category that exposes PII, PHI or that exposes any information that might be described in your organization's internal policies, regulatory framework, privacy requirements or legal requirements as protected.
    Decryption Policy Rule: include the SSL Forward Proxy defined above, and the Decryption Profile defined above.
    Default Value:
    Decryption is not enabled by default."
      reference        : "800-53|SC-17,CSCv6|12.5,ITSG-33|SC-17,LEVEL|2NS,NESA|T7.4.2,NIAv2|CY10,NIAv2|CY12,NIAv2|CY5a,NIAv2|SS25"
      see_also         : "https://workbench.cisecurity.org/files/1664"
      api_request_type : "op"
      request          : "<show><config><merged></merged></config></show>"
      xsl_stmt         : "<xsl:template match=\"/\">"
      xsl_stmt         : "Verify that the Decryption certificate is trusted"
      xsl_stmt         : "<xsl:for-each select=\"//vsys/entry/rulebase/decryption/rules/entry[type/ssl-forward-proxy]\">"
      xsl_stmt         : "Decryption Profile '<xsl:value-of select=\"@name\"/>' is set to type 'SSL Forward Proxy'"
      xsl_stmt         : "</xsl:for-each>"
      xsl_stmt         : "<xsl:if test=\"count(//vsys/entry/rulebase/decryption/rules/entry[type/ssl-forward-proxy])=0\">"
      xsl_stmt         : "No Decryption Profiles using 'SSL Forward Proxy' found"
      xsl_stmt         : "</xsl:if>"
      regex            : ".*"
      expect           : "Manual Review Required"
      severity         : MEDIUM
    </custom_item>
  </then>

  <else>
    <report type:"WARNING">
      description : "Palo Alto software version 7 not found."
      info        : "The target host is not running Palo Alto software version 7 or higher.

      NOTE: Nessus has not identified that the chosen audit applies to the target device."
      see_also    : "https://workbench.cisecurity.org/files/1664"
    </report>
  </else>
</if>

</check_type>
