#
# This script is Copyright (C) 2004-2020 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
#
# $Revision: 1.2 $
# $Date: 2020/05/06 $
#
# Description : This document implements the security configuration as recommended by the
#               DISA Microsoft SharePoint 2010 STIG v1r9
#
#<ui_metadata>
#<display_name>DISA STIG SharePoint 2010 v1r9</display_name>
#<spec>
#  <type>DISA STIG</type>
#  <name>SharePoint 2010</name>
#  <version>1.9.0</version>
#  <link>https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip</link>
#</spec>
#<labels>windows,disa,sharepoint,sharepoint_2010</labels>
#<benchmark_refs>CAT,CCI,Rule-ID,STIG-ID,Vuln-ID,Group-ID</benchmark_refs>
#<variables>
#  <variable>
#    <name>RMS_SERVER</name>
#    <default>http://rmsservername</default>
#    <description>RMS Server</description>
#    <info>The URL of the Windows Rights Management Services (RMS) (or a comparable IRM product) server.</info>
#  </variable>
#  <variable>
#    <name>FARM_SVC_ACCT</name>
#    <default>farmsvcaccount</default>
#    <description>SharePoint farm service account</description>
#    <info>The name of the Active Directory account used to run SharePoint services.</info>
#  </variable>
#  <variable>
#    <name>DOM_SP_SETUP_ACCT</name>
#    <default>domainsharepointsetupaccount</default>
#    <description>Domain SharePoint setup account</description>
#    <info>The name of the Active Directory domain account used to setup SharePoint.</info>
#  </variable>
#  <variable>
#    <name>LOC_SP_SETUP_ACCT</name>
#    <default>localsharepointsetupaccount</default>
#    <description>Local SharePoint setup account</description>
#    <info>The name of the local account used to setup SharePoint.</info>
#  </variable>
#  <variable>
#    <name>SP_AUDIT_GROUP</name>
#    <default>auditgroupname</default>
#    <description>Audit group name</description>
#    <info>The name of the user group with rights to audit SharePoint. If multiple users are required place them in double quotes joined by two ampersands.</info>
#  </variable>
#  <variable>
#    <name>SP_AUDIT_GROUP_USER</name>
#    <default>auditusername</default>
#    <description>Audit group users</description>
#    <info>The names of the accounts used to audit SharePoint, who should be members of the audit group.</info>
#  </variable>
#  <variable>
#    <name>CA_PORT</name>
#    <default>28779</default>
#    <description>SHPT-00-000480 - CA DoD Port</description>
#    <info>SHPT-00-000480 - CA DoD Port</info>
#  </variable>
#</variables>
#</ui_metadata>

<check_type:"Windows" version:"2">
<group_policy:"DISA STIG SharePoint 2010 v1">

<report type:"PASSED">
  description : "DISA_STIG_SharePoint_2010_v1r9.audit from DISA SharePoint 2010 v1r9"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000007 - SharePoint must support the requirement to initiate a session lock after an organizationally defined time period of system or application inactivity has transpired."
  info                    : "A session time-out lock is a temporary action taken when a user stops work and moves away from the immediate physical vicinity of the information system, but does not log out because of the temporary nature of the absence. The session lock is implemented at the point where session activity can be determined. This is typically at the operating system-level, but may also be at the application level. The organization must define the period of inactivity before a session lock is initiated, so this setting must be configurable.

In SharePoint, enabling security validation provides application level security for web pages while the authenticated user is absent. The user must be required to re-authenticate after a specified inactivity period is exceeded."
  solution                : "Configure security validation.
1. In SharePoint Central Administration, click Application Management.
2. On the Application Management page, in the Web Applications list, click Manage web applications.
3. Perform the following step for each web application.
- Select web application.
- Select General Settings.
- Navigate to Web Page Security Validation.
- Set the Security validation is property to On.
- Set the Security validation expires: property to After.
- Set the default timeout period to 10 minutes.
- Select OK to save settings."
  reference               : "800-171|3.1.11,800-53|AC-12,8500.2|PESL-1,CAT|II,CCI|CCI-000057,CN-L3|7.1.2.2(d),CN-L3|7.1.3.7(b),CN-L3|8.1.4.1(b),ITSG-33|AC-12,NIAv2|NS49,Rule-ID|SV-37638r2_rule,STIG-ID|SHPT-00-000007,Vuln-ID|V-27965"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.FormDigestSettings.Enabled -eq $false -Or $_.FormDigestSettings.Expires -eq $false -Or $_.FormDigestSettings.Timeout.minutes -gt 10} | select DisplayName,Url,{$_.FormDigestSettings.Enabled},{$_.FormDigestSettings.Expires},{$_.FormDigestSettings.Timeout.Minutes} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000009 - SharePoint information management policies must be created, configured, and maintained to support the use of organizationally defined security attributes."
  info        : "A SharePoint information management policy is a set of rules governing the availability and behavior of a certain type of content in the application. These policies enable administrators to control and evaluate who can access information, how long to retain information, and how effectively people are complying with the policy. For all systems processing non-publicly releasable information, an information management policy must be applied to content in document libraries and site collections by default. Applying policy to a content type or metadata allows the policy to be applied globally across document libraries, sites, or site collections.

These policies must be created and configured to automatically enforce organizationally-defined security policy to a document library, a site, or a specific content type. Information management policy can be used to apply permissions, audit requirements, security labels, or barcodes based on organizationally defined content types, thus leveraging a centralized security policy and security attributes that binds to SharePoint information while in storage and in process.

NOTE: Sites should run and review usage reports for the information management policy. This report shows how many policies are in place in a web application and how many documents are affected by each policy. This information can help identify which SharePoint sites are not using the global policies which may indicate a compliance issue. The information on this report can also help organizations determine how effectively the organizationally-defined labeling and other compliance requirements documented in the Site Security Plan (SSP) are being implemented.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Create an information management policy and apply to lists, libraries, and list content.
1. On the site collection home page, click Site Actions, then click Site Settings.
2. On the Site Settings page, in the Site Collection Administration list, click Site collection policies.
3. On the Site Collection Policies page, click Create.
4. Follow the menus and prompts to create a name and description for the policy.
5. Configure the desired features to associate with the policy.
6. When finished selecting the options for the individual policy features to add to this information management policy, click OK to apply the policy features.
7. Once an information management policy has been created for the site collection level, apply it to lists, libraries, or list content type in accordance with organizationally defined security requirements."
  reference   : "8500.2|ECAD-1,CAT|II,CCI|CCI-000287,Rule-ID|SV-40023r2_rule,STIG-ID|SHPT-00-000009,Vuln-ID|V-30364"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000010 - SharePoint must maintain and support the use of organizationally defined security attributes to stored information."
  info                    : "Security attributes are metadata representing the basic properties of an entity with respect to safeguarding information. These attributes are typically associated with internal data structures within the application and are used to enable the implementation of access control and flow control policies, reflect special dissemination, handling or distribution instructions, or support other aspects of the information security policy. Some examples of application security attributes include classified, For Official Use Only (FOUO), Personally Identifiable Information (PII), and sensitive.

The term security label is often used to associate a set of security attributes with a specific information object as part of the data structure for that object (e.g., user access privileges, nationality, affiliation as contractor).

A SharePoint information management policy or a third party Information Right Management (IRM) solution must be installed to implement this requirement.  Although a 3rd party solution is recommended for a more robust solution, SharePoint can natively meet this requirement through combined use of information rights policy and defined content type.   Content types must be defined which bind metadata to the content in storage and in process."
  solution                : "To define content types and metadata, perform the following for each desired application security attribute, such as PII or FOUO, as defined by organizational requirements.

1. On the site home page, click Site Actions and then click Site Settings.
2. On the Site Settings page, in the Galleries list, click Site content types.
3. Enter a name for the content type and click OK to view the advanced properties.
4. Scroll down this page and add the columns to prompt the user to enter as metadata or properties to collect when documents of this content type are added to SharePoint."
  reference               : "800-53|SC-16,8500.2|ECAD-1,8500.2|ECML-1,CAT|II,CCI|CCI-002272,ITSG-33|SC-16,NESA|T1.3.2,NESA|T1.3.3,NESA|T4.2.1,Rule-ID|SV-36059r2_rule,STIG-ID|SHPT-00-000010,Vuln-ID|V-27968"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPSite | Get-SPWeb | select -ExpandProperty ContentTypes | where {$_.Group -match \\"Custom Content Types\\"} | select ParentWeb,Name | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000010 - SharePoint must maintain and support the use of organizationally defined security attributes to stored information - Document Library'"
  info                    : "Security attributes are metadata representing the basic properties of an entity with respect to safeguarding information. These attributes are typically associated with internal data structures within the application and are used to enable the implementation of access control and flow control policies, reflect special dissemination, handling or distribution instructions, or support other aspects of the information security policy. Some examples of application security attributes include classified, For Official Use Only (FOUO), Personally Identifiable Information (PII), and sensitive.

The term security label is often used to associate a set of security attributes with a specific information object as part of the data structure for that object (e.g., user access privileges, nationality, affiliation as contractor).

A SharePoint information management policy or a third party Information Right Management (IRM) solution must be installed to implement this requirement.  Although a 3rd party solution is recommended for a more robust solution, SharePoint can natively meet this requirement through combined use of information rights policy and defined content type.   Content types must be defined which bind metadata to the content in storage and in process."
  solution                : "To define content types and metadata, perform the following for each desired application security attribute, such as PII or FOUO, as defined by organizational requirements.

1. On the site home page, click Site Actions and then click Site Settings.
2. On the Site Settings page, in the Galleries list, click Site content types.
3. Enter a name for the content type and click OK to view the advanced properties.
4. Scroll down this page and add the columns to prompt the user to enter as metadata or properties to collect when documents of this content type are added to SharePoint."
  reference               : "800-53|SC-16,8500.2|ECAD-1,8500.2|ECML-1,CAT|II,CCI|CCI-002272,ITSG-33|SC-16,NESA|T1.3.2,NESA|T1.3.3,NESA|T4.2.1,Rule-ID|SV-36059r2_rule,STIG-ID|SHPT-00-000010,Vuln-ID|V-27968"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPSite | Get-SPWeb | select -expandproperty Lists | select -expandproperty ContentTypes | where {$_.Group -match \\"Custom Content Types\\" -and $_.Name -notmatch \\"Gallery\\" -and $_.Name -notmatch \\"Form\\"} | select ParentWeb,ParentList,Name | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000040 - SharePoint must allow authorized users to associate security attributes with information."
  info        : "Security attributes are metadata representing the basic properties of an entity with respect to safeguarding information. These attributes are typically associated with internal data structures within the application and are used to enable the implementation of access control and flow control policies, reflect special dissemination, handling or distribution instructions, or support other aspects of the information security policy. Some examples of application security attributes include classified, FOUO, and sensitive.

The term security label is often used to associate a set of security attributes with a specific information object as part of the data structure for that object (e.g., user access privileges, nationality, affiliation as contractor).

For SharePoint installations, this capability is natively provided once content types, metadata, and an information management policy is configured as required by SHPT-00-000009 and SHPT-00-000010. Once content types are defined, enabled and configured, users will be prompted to enter these attributes when adding new documents or list items.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Create an information management policy and apply to lists, libraries, and list content.
1. On the site collection home page, click Site Actions, point to Site Settings.
2. Click Site Settings.
3. On the Site Settings page, in the Site Collection Administration list, click Site Collection Policies.
4. On the Site Collection Policies page, click Create.
5. Follow the menus and prompts to create a name and description for the policy, and then write a brief policy statement that explains the policy to the users.
6. Configure the desired features to associate with the policy.
7. When you finish selecting the options for the individual policy features that you want to add to this information management policy, click OK to apply the policy features.
8. Once an information management policy has been created for the site collection level, it can be applied to lists, libraries, or list content type."
  reference   : "8500.2|ECAD-1,CAT|II,CCI|CCI-002289,Rule-ID|SV-36067r3_rule,STIG-ID|SHPT-00-000040,Vuln-ID|V-27974"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<report type:"WARNING">
  description : "SHPT-00-000100 - SharePoint must enforce dual authorization, based on organizational policies and procedures for organizationally defined privileged commands."
  info        : "An organization may see fit to define a policy stating certain commands contained within an application require dual authorization before they may be invoked. Dual authorization requires two distinct approving authorities to approve the use of the command prior to being invoked. When the organization defines a set of application related privileged commands requiring dual authorization, the application must support those organizational requirements.

Once an information management policy has been created, the metadata and security attributes created can be enforced using a workflow. However, as with most applications, privilege restrictions, such as dual authorizations cannot be set for the super account, Farm Administrator. When adding a workflow to a SharePoint library or list, this enforces a business process on all items in the library or list. A workflow describes the actions the system or users must perform on each item, such as obtain dual approvals.

Note: If many documents across different libraries require dual authorization, the site should consider creating a content type and adding this type as part of an information management policy.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Create an approval workflow for document libraries or documents which requires dual authorization.
1. On the site home page, click Site Actions, and then click Site Settings.
2. On the Site Settings page, in the Site Administration list, click Site libraries and lists.
3. On the Site Libraries and Lists page, select a library or list.
4. On the List Settings page, in the Permissions and Management list, click Workflow Settings.
5. On the Workflow Settings page, click Add a workflow.
6.  Follow the directions of the workflow wizard to create an approval workflow that requires dual approval for the documents stored in the selected library."
  reference   : "8500.2|ECCD-1,8500.2|ECCD-2,CAT|II,CCI|CCI-000021,Rule-ID|SV-36114r2_rule,STIG-ID|SHPT-00-000100,Vuln-ID|V-27996"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000805 - The organization must employ cryptographic mechanisms to prevent unauthorized disclosure of information during transmission unless otherwise protected by alternative physical measures."
  info                    : "Preventing the disclosure of transmitted information requires that applications take measures to using a cryptographic mechanism to protect the information during transmission. This is usually achieved through the use of TLS, SSL, or Internet Protocol Security (IPSec) Virtual Private Network (VPN)."
  solution                : "1. Open IIS Manager.
2. In the Connections pane, expand Sites.
3. Click the Web Application site.
4. In the Actions pane, click Bindings....
5. In the Site Bindings window, click Add.
6. In the Add Site Binding window, change Type to https and select the site's SSL certificate.
7.Click OK and then click Close."
  reference               : "800-171|3.13.8,800-53|SC-8,8500.2|ECCT-1,8500.2|ECCT-2,CAT|II,CCI|CCI-002421,CN-L3|8.1.2.2(a),CN-L3|8.1.2.2(b),CN-L3|8.1.4.7(a),CN-L3|8.1.4.8(a),CN-L3|8.2.4.5(c),CN-L3|8.2.4.5(d),CN-L3|8.5.2.2,CSF|PR.DS-2,CSF|PR.DS-5,ITSG-33|SC-8,NESA|T4.3.1,NESA|T4.3.2,NESA|T4.5.1,NESA|T4.5.2,NESA|T7.3.3,NESA|T7.4.1,NIAv2|IE12,NIAv2|IE8,NIAv2|IE9,NIAv2|NS29,NIAv2|SS24,Rule-ID|SV-36661r2_rule,STIG-ID|SHPT-00-000805,Vuln-ID|V-28023"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPSite | Get-SPWeb | Where-Object {$_.Url -notmatch \\"^https:\\"}'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000810 - SharePoint must identify potentially security-relevant error conditions."
  info                    : "The error messages and usage data to be monitored should be carefully considered. The extent to which the application is able to identify and handle error conditions is guided by organizational policy and operational requirements.

Usage and Health Data Collection Service Application collects data about usage and health of your farm. This information is used for Health Monitoring and this is also required for running the Web Analytics Service. If there is no Usage and Health Data Collection Service Application or the Usage and Health Data Collection Proxy is stopped, the Web Analytics Report will not show any data.

SharePoint Usage and Health Data Collection Service Application must be enabled in order to detect potential security errors. The usage and health data settings are farm-wide and cannot be set for individual servers in the farm."
  solution                : "Enable and configure the Usage and Health Data Collection Service Application.
1. In SharePoint Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. On the Configure web analytics and health data collection page, in the Usage Data Collection section, check the box for Enable usage data collection.
4. In the Health Data Collection section, check the box for Enable health data collection.
5. Click OK."
  reference               : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,8500.2|DCBP-1,CAT|II,CCI|CCI-001312,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,Rule-ID|SV-36713r2_rule,STIG-ID|SHPT-00-000810,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1,Vuln-ID|V-28026"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : "LoggingEnabled : True"
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPUsageService | select LoggingEnabled |Format-List'
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000640 - Applications must support organizational requirements to employ cryptographic mechanisms to protect information in storage."
  info        : "When data is written to digital media there is risk of data loss and data compromise. An organizational assessment of risk guides the selection of media and associated information contained on the media requiring restricted access. Organizations need to document in policy and procedures, the media requiring restricted access, individuals authorized to access the media, and the specific measures taken to restrict access.  Encryption of data at rest in SQL is required if the data owner deems it necessary.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Data-at-rest encryption is provided by encryption of the SQL 2008 SharePoint database using TDE or a third party solution. Each of the following scripts must be run as TSQL queries and replace string text with suitable replacements.

Navigate to the SQL Server Management Console and open a new query window to run the following script.

1.  Create the DMK.

USE master;
GO
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'CrypticTDEpw4CompanyABC';
GO

2.  Create the TDE Certificate.

USE master;
GO
CREATE CERTIFICATE CompanyABCtdeCert WITH SUBJECT = 'CompanyABC TDE Certificate';
GO

3.  Back up the TDE Certificate.

USE master;
GO
BACKUP CERTIFICATE CompanyABCtdeCert TO FILE = 'C:\Backup\CompanyABCtdeCERT.cer'
WITH PRIVATE KEY (
FILE = 'C:\Backup\CompanyABCtdeCert.pvk',
ENCRYPTION BY PASSWORD = 'CrypticTDEpw4CompanyABC!');
GO

4.  Create the DEK.

USE SharePointContentDB;
GO
CREATE DATABASE ENCRYPTION KEY
WITH ALGORITHM = AES_256
ENCRYPTION BY SERVER CERTIFICATE CompanyABCtdeCert
GO

5.  Encrypt the database.

USE SharePointContentDB
GO
ALTER DATABASE SharePointContentDB
SET ENCRYPTION ON
GO

6.  Monitor the progress; once encryption_state is '3', the database is encrypted.
USE SharePointContentDB
GO
SELECT *
FROM sys.dm_database_encryption_keys
WHERE encryption_state = 3;
GO"
  reference   : "8500.2|ECCR-1,CAT|I,CCI|CCI-002475,Rule-ID|SV-37792r2_rule,STIG-ID|SHPT-00-000640,Vuln-ID|V-28066"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000645 - SharePoint must terminate the network connection associated with a communications session at the end of the session or after an organizationally defined time period of inactivity - 'FormDigestSettings.Enabled = True'"
  info                    : "This requirement applies to both internal and external networks. Terminating network connections associated with communications sessions include, de-allocating associated TCP/IP address/port pairs at the operating-system level, or de-allocating networking assignments at the application level if multiple application sessions are using a single operating system-level network connection.

The time period of inactivity may, as the organization deems necessary, be a set of time periods by type of network access or for specific accesses."
  solution                : "1. In SharePoint Central Administration, click Application Management.
2. On the Application Management page, in the Web Applications list, click Manage web applications.
3. Click a web application, and then click General Settings in the Manage section of the ribbon.
4. In the Web Application General Settings dialog window, in the Web Page Security Validation section, set Web Page Security Validation to On and a value less than 10 minutes."
  reference               : "800-171|3.1.11,800-53|AC-12,8500.2|DCBP-1,CAT|II,CCI|CCI-001133,CN-L3|7.1.2.2(d),CN-L3|7.1.3.7(b),CN-L3|8.1.4.1(b),ITSG-33|AC-12,NIAv2|NS49,Rule-ID|SV-37794r2_rule,STIG-ID|SHPT-00-000645,Vuln-ID|V-28071"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.FormDigestSettings.Enabled -eq $false -Or $_.FormDigestSettings.Expires -eq $false -Or $_.FormDigestSettings.Timeout.minutes -gt 10} | select DisplayName,Url,{$_.FormDigestSettings.Enabled},{$_.FormDigestSettings.Expires},{$_.FormDigestSettings.Timeout.Minutes} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint UsageLogDir defined"
      value_type              : POLICY_TEXT
      value_data              : "UsageLogDir[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000430 - SharePoint must protect audit information from unauthorized access to the usage and health logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is difficult. To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized access.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where usage data collection is stored:
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000162,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36596r2_rule,STIG-ID|SHPT-00-000430,SWIFT-CSCv1|5.1,Vuln-ID|V-28087"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPUsageService | select UsageLogDir -ExpandProperty UsageLogDir; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000430 - SharePoint must protect audit information from unauthorized access to the usage and health logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is difficult. To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized access.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where usage data collection is stored:
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000162,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36596r2_rule,STIG-ID|SHPT-00-000430,SWIFT-CSCv1|5.1,Vuln-ID|V-28087"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint UsageLodDir defined"
      value_type              : POLICY_TEXT
      value_data              : "UsageLogDir[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000435 - SharePoint must protect audit information from unauthorized modification of usage and health data collection logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized modification.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database. Only designated audit administrators and internal accounts should have any type of permission to these files."
      solution                : "Check the directory permissions where usage data collection is stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000163,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36597r2_rule,STIG-ID|SHPT-00-000435,SWIFT-CSCv1|5.1,Vuln-ID|V-28089"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPUsageService | select UsageLogDir -ExpandProperty UsageLogDir; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000435 - SharePoint must protect audit information from unauthorized modification of usage and health data collection logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized modification.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database. Only designated audit administrators and internal accounts should have any type of permission to these files."
      solution                : "Check the directory permissions where usage data collection is stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000163,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36597r2_rule,STIG-ID|SHPT-00-000435,SWIFT-CSCv1|5.1,Vuln-ID|V-28089"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint UsageLogDir defined"
      value_type              : POLICY_TEXT
      value_data              : "UsageLogDir[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000440 - SharePoint must protect audit information from unauthorized deletion of usage and health logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized deletion.

SharePoint is an integrated product with comprehensive built-in auditing capabilities that works with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where usage data collection is stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000164,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36598r2_rule,STIG-ID|SHPT-00-000440,SWIFT-CSCv1|5.1,Vuln-ID|V-28094"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPUsageService | select UsageLogDir -ExpandProperty UsageLogDir; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000440 - SharePoint must protect audit information from unauthorized deletion of usage and health logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized deletion.

SharePoint is an integrated product with comprehensive built-in auditing capabilities that works with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where usage data collection is stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure usage and health data collection.
3. Obtain the Log file location for the Usage Data Collection Settings.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000164,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36598r2_rule,STIG-ID|SHPT-00-000440,SWIFT-CSCv1|5.1,Vuln-ID|V-28094"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000445 - SharePoint must protect audit tools from unauthorized access - 'Verify Site Collection Administrators'"
  info                    : "Protecting audit data also includes identifying and protecting the tools used to view and manipulate log data. Depending upon the log format and application, system and application log tools may provide the only means to manipulate and manage application and system log data.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.), are stored in a SQL database."
  solution                : "Remove users and groups from the site administrator / site owner groups.
Remove unneeded identifiers from site collection administrators.

1. On the site home page, click Site Actions, and then click Site Settings.
2. On the Site Settings page, in the Users and Permissions list, click 'Site collection administrators'.
3. Remove any non-site owner users or groups.
4. Click OK.

Change permissions on users and groups not requiring full site control.
1. On the site home page, click Site Actions, and then click Site Permissions.
2. Put users not requiring full control in groups with less privilege (i.e., Site contributor, site user)."
  reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-001493,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36599r2_rule,STIG-ID|SHPT-00-000445,SWIFT-CSCv1|5.1,Vuln-ID|V-28097"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : "Get-SPSite | select RootWeb,Url,Owner | Format-List"
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000445 - SharePoint must protect audit tools from unauthorized access - 'Verify Users and Groups with Full Control'"
  info                    : "Protecting audit data also includes identifying and protecting the tools used to view and manipulate log data. Depending upon the log format and application, system and application log tools may provide the only means to manipulate and manage application and system log data.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.), are stored in a SQL database."
  solution                : "Remove users and groups from the site administrator / site owner groups.
Remove unneeded identifiers from site collection administrators.

1. On the site home page, click Site Actions, and then click Site Settings.
2. On the Site Settings page, in the Users and Permissions list, click 'Site collection administrators'.
3. Remove any non-site owner users or groups.
4. Click OK.

Change permissions on users and groups not requiring full site control.
1. On the site home page, click Site Actions, and then click Site Permissions.
2. Put users not requiring full control in groups with less privilege (i.e., Site contributor, site user)."
  reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-001493,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-36599r2_rule,STIG-ID|SHPT-00-000445,SWIFT-CSCv1|5.1,Vuln-ID|V-28097"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPSite | Get-SPWeb | Select-Object -ExpandProperty Roles | Where-Object {$_.Name -eq \\"Full Control\\"} | Select-Object ParentWeb,Users,Groups,Name | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000315 - SharePoint must allow designated organizational personnel to select which auditable events are to be audited by specific components of the system."
  info        : "Without auditing enabled, individual system accesses cannot be tracked and malicious activity cannot be detected and traced back to an individual account.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Ensure the auditing information management policy is configured to be available.
1. In SharePoint Central Administration, click Security.
2. On the Security page, in the Information policy list, click Configure Information Management Policy.
3. On the Information Management Policy Configuration page, select Auditing.
4. Select the option Available for use in new site and list policies.
5. Click Save."
  reference   : "8500.2|ECAT-1,8500.2|ECAT-2,CAT|II,CCI|CCI-000171,Rule-ID|SV-37767r2_rule,STIG-ID|SHPT-00-000315,Vuln-ID|V-28114"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type        : AUDIT_IIS_APPCMD
  description : "SHPT-00-000530 - The Central Administration Web Application must use Kerberos as the authentication provider."
  info        : "An authentication process resists replay attacks if it is impractical to achieve a successful authentication by recording and replaying a previous authentication message.

Techniques used to address this include protocols using nonce's or challenges (e.g., Transport Layer Security (TLS), WS_Security), and time synchronous or challenge-response one-time authenticators."
  solution    : "Enable Kerberos on the Central Administration Web Application.
1. In SharePoint Central Administration, click Application Management.
2. On the Application Management page, in the Web Applications list, click Manage web applications.
3. On the Web Application Management page, click the Central Administration Web Application, and then click Authentication Providers in the Security section of the ribbon.
4. In the Authentication Providers dialog window, click the associated zone that processes sensitive information (not public releasable) and enable Integrated Windows authentication with Negotiate (Kerberos) and click Save."
  reference   : "800-171|3.5.1,800-53|IA-2,8500.2|IAIA-1,8500.2|IAIA-2,CAT|II,CCI|CCI-001941,CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.5.4.1(a),CSF|PR.AC-1,ITSG-33|IA-2,NESA|T2.3.8,NESA|T5.3.1,NESA|T5.4.2,NESA|T5.5.1,NESA|T5.5.2,NESA|T5.5.3,NIAv2|AM14b,NIAv2|AM2,NIAv2|AM8,Rule-ID|SV-36726r2_rule,STIG-ID|SHPT-00-000530,TBA-FIISB|35.1,TBA-FIISB|36.1,Vuln-ID|V-28119"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type  : POLICY_TEXT
  value_data  : '[\s]*value[\s]*:[\s]*\\"negotiate\\"'
  appcmd_args : 'list config "SharePoint Central Administration v4" -section:system.webServer/security/authentication/windowsAuthentication -text:*'
  check_type  : CHECK_REGEX
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000600 - SharePoint managed service accounts must be set to enable automatic password change."
  info                    : "Passwords have a number of inherent risks. One method of minimizing this risk is to enforce the use of complex passwords. Another method is to enforce periodic password changes. If the information system does not limit the lifetime of passwords and force password changes, the system may be vulnerable to password attacks and may become compromised.

This setting only enables automatic password changes for managed account. These accounts are in AD DS. The Windows server STIG guidance requires annual password changes for all service accounts."
  solution                : "1. In SharePoint Central Administration, click Security.
2. On the Security page, in the General Security list, click Configure managed accounts.
3. Edit setting for each managed account.
4. Select 'Enable automatic password change'."
  reference               : "800-53|IA-5(1),8500.2|IAGA-1,CAT|II,CCI|CCI-000199,CN-L3|7.1.2.7(e),CN-L3|7.1.3.1(b),CSF|PR.AC-1,ISO/IEC-27001|A.9.4.3,ITSG-33|IA-5(1),NESA|T5.2.3,NIAv2|AM20,NIAv2|AM21,Rule-ID|SV-37784r2_rule,STIG-ID|SHPT-00-000600,SWIFT-CSCv1|4.1,TBA-FIISB|26.2.2,Vuln-ID|V-28138"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPManagedAccount | Where-Object {$_.AutomaticChange -ne 1} | select DisplayName | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type        : GROUP_MEMBERS_POLICY
  description : "SHPT-00-000465 - SharePoint must support the requirement that privileged access is further defined between audit-related privileges and other privileges."
  info        : "Protection of audit records and audit data is of critical importance. Care must be taken to ensure privileged users cannot circumvent audit protections put in place. Auditing might not be reliable when performed by an information system which the user being audited has privileged access. The privileged user could inhibit auditing or directly modify audit records. To prevent this from occurring, privileged access shall be further defined between audit-related privileges and other privileges, thus, limiting the users with audit-related privileges. Reducing the risk of audit compromises by privileged users can also be achieved by performing audit activity on a separate information system where the user in question has limited access or by using storage media that cannot be modified (e.g., write-once recording devices)."
  solution    : "1. Create a SharePoint audit security group in AD or use an existing audit administrators group that has been designated and authorized to perform audit functions.
2. Add the accounts of authorized audit administrators to the group.
3. On the server(s) for which the SharePoint software is installed, navigate to Server Manager -> Local Users and Groups.
4. View the properties of each group and verify that this account is a member of the Administrators group and no other groups."
  reference   : "800-171|3.3.8,800-53|AU-9(2),8500.2|ECTP-1,CAT|II,CCI|CCI-001351,CN-L3|8.1.3.5(d),CN-L3|8.1.4.3(c),CSF|PR.PT-1,ITSG-33|AU-9(2),NESA|M5.2.3,NESA|M5.5.2,NIAv2|SS13e,Rule-ID|SV-36578r2_rule,STIG-ID|SHPT-00-000465,Vuln-ID|V-28144"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type  : POLICY_TEXT
# Note: Variable @SP_AUDIT_GROUP_USER@ replaced with "auditusername" in field "value_data".
  value_data  : "auditusername"
# Note: Variable @SP_AUDIT_GROUP@ replaced with "auditgroupname" in field "group_name".
  group_name  : "auditgroupname"
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000475 - To support the requirements and principles of least functionality; SharePoint must support the organizational requirement to provide only essential capabilities."
  info                    : "Information systems are capable of providing a wide variety of functions and services. Some of the functions and services, provided by default, may not be necessary to support essential organizational operations (e.g., key missions, functions).

Additionally, it is sometimes convenient to provide multiple services from a single component of an information system, but doing so increases risk over limiting the services provided by any one component.

Services not necessary to the SharePoint installation must not be installed on the servers in the farm."
  solution                : "Follow these steps to access the management pages of a service application by using Central Administration.
1. Navigate to the Central Administration home page.
2. In the Application Management section, click Manage Service Applications.
3. From the Manage Service Applications page, select the service application to be removed.
4. Remove all services that are not needed or approved for use by the organization."
  reference               : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,8500.2|DCPP-1,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|8.1.4.4(a),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,NIAv2|SS15a,Rule-ID|SV-37768r1_rule,STIG-ID|SHPT-00-000475,SWIFT-CSCv1|2.3,Vuln-ID|V-28169"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPServiceApplication | select DisplayName,Status | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000480 - When configuring Central Administration, the port number selected must comply with  DoD Ports and Protocol Management (PPSM) program requirements."
  info                    : "During the installation of Microsoft SharePoint, the Central Administration Web site is established on a randomly-assigned TCP port by default. Allowing a randomly-assigned default may result in use of a port which violates DoD policy or conflicts with ports already in use.  Use of certain well-known ports may also result in slow operational responses or may expose the application to denial of service attacks."
  solution                : "1. Open the SharePoint 2010 Management Shell (Start > All Programs > Microsoft SharePoint 2010 Products > SharePoint 2010 Management Shell).
2. Change the port number to a PPSM approved port which does not conflict with existing port usage by using the following command:
-Set -SPCentralAdministration -Port <PortNumber>.
3. Press Enter to save."
  reference               : "800-171|3.4.2,800-53|CM-6,8500.2|DCPP-1,CAT|II,CCI|CCI-000382,CN-L3|8.1.10.6(d),CSF|PR.IP-1,ITSG-33|CM-6,NESA|T3.2.1,Rule-ID|SV-37769r2_rule,STIG-ID|SHPT-00-000480,SWIFT-CSCv1|2.3,Vuln-ID|V-28170"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
# Note: Variable @CA_PORT@ replaced with "28779" in field "value_data".
  value_data              : "Port[\s]+:[\s]+28779"
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication -includecentraladministration |where {$_.IsAdministrationWebApplication} | Get-SPSite -identity {$_.Url} | select Port | Format-List'
  check_type              : CHECK_REGEX
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000495 - Backup of SharePoint system level files for critical systems must be performed when identified as required by the owning organization."
  info        : "Information system backup is a critical step in maintaining data assurance and availability. System-level information includes: system-state information, operating system and application software, and licenses.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Backup SharePoint farm servers, particularly those designated as critical information systems periodically on a schedule identified by the DAA or designated representative."
  reference   : "8500.2|CODB-1,8500.2|CODB-2,8500.2|CODB-3,CAT|II,CCI|CCI-000537,Rule-ID|SV-36698r1_rule,STIG-ID|SHPT-00-000495,Vuln-ID|V-28177"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000405 - To support audit review, analysis, and reporting, SharePoint must integrate audit review, analysis, and reporting processes to support organizational processes for investigation and response to suspicious activities."
  info                    : "Successful incident response and auditing relies on timely, accurate system information and analysis in order to allow the organization to identify and respond to potential incidents in a proficient manner.

Audit review, analysis, and reporting are all activities are related to the evaluation of system activity through the inspection and analysis of system log data.

Some examples include, but are not limited to, organizational requirements to cooperate with legal counsel and/or auditors in order to provide reports on certain types of system activity or analyzing system logs to ascertain sources or causes of certain system activity."
  solution                : "1. On the site collection home page, click Site Actions, and then click Site Settings.
2. On the Site Settings page, in the Site Collection Administration list, click on Site collection audit settings.
3. In the Documents and Items section, specify the events to audit.
4. In the Lists, Libraries, and Sites section, specify the events to audit.
5. Click OK."
  reference               : "800-171|3.3.1,800-53|AU-3(2),8500.2|ECAT-1,8500.2|ECAT-2,CAT|III,CCI|CCI-001864,CSF|PR.PT-1,ITSG-33|AU-3(2),Rule-ID|SV-36581r1_rule,STIG-ID|SHPT-00-000405,SWIFT-CSCv1|6.4,Vuln-ID|V-28184"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication -IncludeCentralAdministration | where {$_.isadministrationwebapplication} | Get-SPSite | where {$_.Audit.AuditFlags -ne 15295} | select Url,{$_.Audit.AuditFlags} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000760 - SharePoint must implement security functions as largely independent modules to avoid unnecessary interactions between modules - No Applications assigned to Default App Pool"
  info                    : "Microsoft recommends separate Application Pools (and security accounts) for site collections with authenticated and anonymous content; to isolate applications storing security or management information; or where users have great liberty to create and administer sites and to collaborate on content. With this configuration, if an attacker gains control of one Application Pool, they do not gain universal access to all data hosted in the SharePoint farm.

Configuring separate Application Pools with the appropriate security based on access and content allows for content isolation and load balancing, limiting access to specific servers. Organizations can use custom HTTP modules for specific zones to create unique sign-on rules based on these groups of users."
  solution                : "Consult the IIS STIG for further guidance. Either remove applications from the application pool or create a separate application pool for the SharePoint Central Administration site."
  reference               : "800-53|SC-3,8500.2|DCSP-1,CAT|II,CCI|CCI-002383,ITSG-33|SC-3,NESA|T3.4.1,NESA|T4.3.1,NESA|T4.3.2,Rule-ID|SV-37789r2_rule,STIG-ID|SHPT-00-000760,Vuln-ID|V-28207"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.ApplicationPool -like \\"\*DefaultAppPool\*\\"} | select ApplicationPool | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000760 - SharePoint must implement security functions as largely independent modules to avoid unnecessary interactions between modules - Internet & Extranet assigned to diff App Pools"
  info                    : "Microsoft recommends separate Application Pools (and security accounts) for site collections with authenticated and anonymous content; to isolate applications storing security or management information; or where users have great liberty to create and administer sites and to collaborate on content. With this configuration, if an attacker gains control of one Application Pool, they do not gain universal access to all data hosted in the SharePoint farm.

Configuring separate Application Pools with the appropriate security based on access and content allows for content isolation and load balancing, limiting access to specific servers. Organizations can use custom HTTP modules for specific zones to create unique sign-on rules based on these groups of users."
  solution                : "Consult the IIS STIG for further guidance. Either remove applications from the application pool or create a separate application pool for the SharePoint Central Administration site."
  reference               : "800-53|SC-3,8500.2|DCSP-1,CAT|II,CCI|CCI-002383,ITSG-33|SC-3,NESA|T3.4.1,NESA|T4.3.1,NESA|T4.3.2,Rule-ID|SV-37789r2_rule,STIG-ID|SHPT-00-000760,Vuln-ID|V-28207"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | select ApplicationPool | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000760 - SharePoint must implement security functions as largely independent modules to avoid unnecessary interactions between modules - Central Administration is a separate App Pool"
  info                    : "Microsoft recommends separate Application Pools (and security accounts) for site collections with authenticated and anonymous content; to isolate applications storing security or management information; or where users have great liberty to create and administer sites and to collaborate on content. With this configuration, if an attacker gains control of one Application Pool, they do not gain universal access to all data hosted in the SharePoint farm.

Configuring separate Application Pools with the appropriate security based on access and content allows for content isolation and load balancing, limiting access to specific servers. Organizations can use custom HTTP modules for specific zones to create unique sign-on rules based on these groups of users."
  solution                : "Consult the IIS STIG for further guidance. Either remove applications from the application pool or create a separate application pool for the SharePoint Central Administration site."
  reference               : "800-53|SC-3,8500.2|DCSP-1,CAT|II,CCI|CCI-002383,ITSG-33|SC-3,NESA|T3.4.1,NESA|T4.3.1,NESA|T4.3.2,Rule-ID|SV-37789r2_rule,STIG-ID|SHPT-00-000760,Vuln-ID|V-28207"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.ApplicationPool -eq $(Get-SPWebApplication -IncludeCentralAdministration | Where-Object {$_.IsAdministrationWebApplication} | select ApplicationPool).ApplicationPool} | select DisplayName,ApplicationPool | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000130 - For environments requiring an Internet-facing capability, the SharePoint application server upon which Central Administration is installed must not be installed in the DMZ."
  info        : "Information flow control regulates where information is allowed to travel within and between information systems (as opposed to who is allowed to access the information) and without explicit regard to subsequent accesses to the information.

SharePoint Central Administrator is a powerful management tool used to administer the farm. This server should be installed on a trusted network segment. This server should be used to run required services rather than user-oriented web applications.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remove the application server from the DMZ."
  reference   : "8500.2|EBBD-1,8500.2|EBBD-2,8500.2|EBBD-3,CAT|II,CCI|CCI-001414,Rule-ID|SV-36120r2_rule,STIG-ID|SHPT-00-000130,Vuln-ID|V-28217"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000165 - Enable IRM to bind attributes to info to facilitate the established information flow policy - 'IRM is enabled'"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : "[Microsoft.SharePoint.Administration.SPWebService]::ContentService | Select-Object -ExpandProperty IrmSettings | Where-Object {$_.IrmRMSEnabled -ne 1} | Select-Object IrmRMSEnabled | Format-List"
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000165 - SharePoint must enable IRM to bind attributes to information to facilitate the organization's established information flow policy as needed."
      info                    : "The application enforces approved authorizations for controlling the flow of information within the system and between interconnected systems in accordance with applicable policy. Information flow control regulates where information is allowed to travel within an information system and between information systems (as opposed to who is allowed to access the information) and without explicit regard to subsequent accesses to that information.

Attribution is a critical component of a security concept of operations. The ability to identify source and destination points for information flowing in an information system, allows forensic reconstruction of events when required, and increases policy compliance by attributing policy violations to specific organizations/individuals. Binding security attributes to information allows policy enforcement mechanisms to act on that information and enforce policy."
      solution                : "1. In Central Administration, click on Security.
2. On the Security page, in the Information policy list, click 'Configure information rights management'.
3. Select 'Use the default RMS server specified in Active Directory' or identify a specific server by selecting 'Use this RMS server:' and entering the server name."
      reference               : "800-53|SC-16,8500.2|EBBD-1,8500.2|EBBD-2,8500.2|EBBD-3,CAT|III,CCI|CCI-002210,ITSG-33|SC-16,NESA|T1.3.2,NESA|T1.3.3,NESA|T4.2.1,Rule-ID|SV-36418r2_rule,STIG-ID|SHPT-00-000165,Vuln-ID|V-28230"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
# Note: Variable @RMS_SERVER@ replaced with "http://rmsservername" in field "powershell_args".
      powershell_args         : '[Microsoft.SharePoint.Administration.SPWebService]::ContentService | Select-Object -ExpandProperty IrmSettings | Where-Object {$_.IrmRMSCertServer -ne \\"http://rmsservername\\"} | Select-Object IrmRMSCertServer | Format-List'
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000165 - SharePoint must enable IRM to bind attributes to information to facilitate the organization's established information flow policy as needed."
      info                    : "The application enforces approved authorizations for controlling the flow of information within the system and between interconnected systems in accordance with applicable policy. Information flow control regulates where information is allowed to travel within an information system and between information systems (as opposed to who is allowed to access the information) and without explicit regard to subsequent accesses to that information.

Attribution is a critical component of a security concept of operations. The ability to identify source and destination points for information flowing in an information system, allows forensic reconstruction of events when required, and increases policy compliance by attributing policy violations to specific organizations/individuals. Binding security attributes to information allows policy enforcement mechanisms to act on that information and enforce policy."
      solution                : "1. In Central Administration, click on Security.
2. On the Security page, in the Information policy list, click 'Configure information rights management'.
3. Select 'Use the default RMS server specified in Active Directory' or identify a specific server by selecting 'Use this RMS server:' and entering the server name."
      reference               : "800-171|3.1.1,800-53|SC-16,8500.2|EBBD-1,8500.2|EBBD-2,8500.2|EBBD-3,CAT|III,CCI|CCI-002210,CSF|PR.AC-4,CSF|PR.PT-3,ISO/IEC-27001|A.9.4.1,ITSG-33|SC-16,NESA|T1.3.2,NESA|T1.3.3,NESA|T4.2.1,Rule-ID|SV-36418r2_rule,STIG-ID|SHPT-00-000165,Vuln-ID|V-28230"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : "[Microsoft.SharePoint.Administration.SPWebService]::ContentService | Select-Object -ExpandProperty IrmSettings | Where-Object {$_.IrmRMSEnabled -ne 1} | Select-Object IrmRMSEnabled | Format-List"
    </custom_item>
  </else>
</if>

<report type:"WARNING">
  description : "SHPT-00-000190 - SharePoint must enforce organizational requirements to implement separation of duties through assigned information access authorizations."
  info        : "Separation of duties is a prevalent Information Technology control implemented at different layers of the information system including the operating system and in applications. It serves to eliminate or reduce the possibility that a single user may carry out a prohibited action. Separation of duties requires that the person accountable for approving an action is not the same person who is tasked with implementing or carrying out the action.

Additionally, the person or entity accountable for monitoring the activity must be separate as well. To meet this requirement, applications, when applicable, shall be divided where functionality is based on roles and duties. Examples of separation of duties include: (i) mission functions and distinct information system support functions are divided among different individuals/roles; (ii) different individuals perform information system support functions (e.g., system management, systems programming, configuration management, quality assurance and testing, network security); (iii) security personnel who administer access control functions do not administer audit functions; and (iv) different administrator accounts for different roles.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Create and/or confirm the three required permission levels exist and have permissions in accordance with organizationally defined permissions.
1. On a site home page, click Site Actions, and then click Site Permissions.
2. In the Manage section of the ribbon, click Permission Levels.
3.  Create missing permission levels by clicking Add a Permission Level.
4. On the Add a Permission Level page, in the Name field, type a name for the new permission level (Web Site Admin, Web Site Audit, or Web Site Manager).
5. In the Description field, type a description of the new permission level.
6. In the list of permissions, select the check boxes to add permissions to the permission level according to the organizationally defined permissions from the IAO.
7. Click Create."
  reference   : "8500.2|ECLP-1,CAT|II,CCI|CCI-002220,Rule-ID|SV-37759r2_rule,STIG-ID|SHPT-00-000190,Vuln-ID|V-28241"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000210 - Timer job retries for automatic password change on Managed Accounts must meet DoD password retry policy."
  info                    : "When an authentication method is exposed to allow for the utilization of an application, there is a risk that attempts will be made to obtain unauthorized access. To defeat these attempts, organizations define the number of times a user account may consecutively fail a log in attempt. The organization also defines the period of time in which these consecutive failed attempts may occur. By limiting the number of failed log in attempts, the risk of unauthorized system access via user password guessing otherwise known as brute forcing is reduced. Limits are imposed by locking the account.

The automatic password change feature for Managed Accounts allows SharePoint to automatically generate new strong passwords on a schedule set by the administrator. This generates a password change job in the Timer Service. Limiting the number of times the job attempts to change the password, will help guard against a password change attack."
  solution                : "1. In SharePoint Central Administration, click Security.
2. On the Security page, in the General Security list, click Configure password change settings.
3. On the Password Management Settings page, in the Automatic Password Change Settings section, set the 'Number of retries before password change timer fails:' to 3."
  reference               : "800-171|3.1.8,800-53|AC-7,8500.2|ECLO-1,8500.2|ECLO-2,CAT|II,CCI|CCI-000044,CN-L3|8.1.4.1(b),ITSG-33|AC-7,NESA|T5.5.1,NIAv2|AM24,Rule-ID|SV-37975r2_rule,STIG-ID|SHPT-00-000210,TBA-FIISB|36.2.4,TBA-FIISB|45.1.2,TBA-FIISB|45.2.1,TBA-FIISB|45.2.2,Vuln-ID|V-28249"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : "\.[Pp]assword[Cc]hange[Mm]aximum[Tt]ries[\s]*:[\s]*[1-3]"
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPFarm | select {$_.PasswordChangeMaximumTries} | Format-List'
  check_type              : CHECK_REGEX
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000235 - SharePoint clients must be configured to display an approved system use notification message or banner before granting access to the system."
  info        : "Applications are required to display an approved system use notification message or banner before granting access to the system that provides privacy and security notices consistent with applicable federal laws, Executive Orders, directives, policies, regulations, standards, and guidance and states:

(i) users are accessing a U.S. Government information system;
(ii) system usage may be monitored, recorded, and subject to audit;
(iii) unauthorized use of the system is prohibited and subject to criminal and civil penalties; and
(iv) use of the system indicates consent to monitoring and recording.

System use notification messages can be implemented in the form of warning banners displayed when individuals log in to the information system.

System use notification is intended only for information system access that includes an interactive login interface with a human user and is not intended to require notification when an interactive interface does not exist.

Use this banner for desktops, laptops, and other devices accommodating banners of 1300 characters. The banner shall be implemented as a click-through banner at logon (to the extent permitted by the operating system), meaning it prevents further activity on the information system unless and until the user executes a positive action to agree by clicking on a box indicating 'OK' or some other equivalent action.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Configure the SharePoint web application's home page to display the authorized DoD warning banner text on or before the login page."
  reference   : "8500.2|ECWM-1,CAT|II,CCI|CCI-000048,Rule-ID|SV-36428r2_rule,STIG-ID|SHPT-00-000235,Vuln-ID|V-28252"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<report type:"WARNING">
  description : "SHPT-00-000240 - SharePoint must retain the notification message or banner on the screen until users take explicit actions to log on to or further access."
  info        : "To establish acceptance of system usage policy, a click-through banner at application logon is required. The banner shall prevent further activity on the application unless and until the user executes a positive action to agree by clicking on a box indicating 'OK' or agreement with the terms of the banner. The text of this banner should be customizable in the event of future user agreement changes.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Configure the SharePoint Web application home page to not allow any further access until the user executes a positive action to agree."
  reference   : "8500.2|ECWM-1,CAT|II,CCI|CCI-000050,Rule-ID|SV-36431r1_rule,STIG-ID|SHPT-00-000240,Vuln-ID|V-28254"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<report type:"WARNING">
  description : "SHPT-00-000245 - SharePoint must be configured to display the banner, when appropriate, before granting further access."
  info        : "Applications are required to display the following information:

(i) displays the system use information when appropriate, before granting further access;
(ii) displays references, if any, to monitoring, recording, or auditing consistent with privacy accommodations for such systems that generally prohibit those activities; and
(iii) includes in the notice given to public users of the information system, a description of the authorized uses of the system.

System use notification messages can be implemented in the form of warning banners displayed when individuals login to the information system. System use notification is intended only for information system access including an interactive login interface with a human user and is not intended to require notification when an interactive interface does not exist.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Configure publicly accessible SharePoint Web applications home page to display a DoD warning banner before logging in."
  reference   : "8500.2|ECWM-1,CAT|II,CCI|CCI-001384,CCI|CCI-001385,CCI|CCI-001386,CCI|CCI-001387,CCI|CCI-001388,Rule-ID|SV-36432r1_rule,STIG-ID|SHPT-00-000245,Vuln-ID|V-28256"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000690 - The Central Administration site must not be accessible from Extranet or Internet connections."
  info                    : "SharePoint must prevent the presentation of information system management-related functionality at an interface utilized by general, (i.e., non-privileged), users.

Central Administration is an application used to manage SharePoint system settings and the settings of the web applications running under SharePoint. The Central Administration application should be protected using a defense-in-depth approach. Regular users should not be able to access the Central Administration as the first line of defense. The second line of defense is that regular users do not have user ids defined in the Central Administration application."
  solution                : "Block outside Central Administration access.
Use IIS IP address restrictions, firewall, or other filtering solutions to limit access to the Central Administration site."
  reference               : "800-171|3.13.1,800-53|SC-7(11),8500.2|DCPA-1,CAT|II,CCI|CCI-001083,CSF|PR.AC-5,CSF|PR.PT-4,ITSG-33|SC-7(11),NIAv2|GS7c,Rule-ID|SV-36741r2_rule,STIG-ID|SHPT-00-000690,TBA-FIISB|31.3,Vuln-ID|V-28281"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication -IncludeCentralAdministration | Where-Object {$_.IsAdministrationWebApplication} | select Url | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<report type:"WARNING">
  description : "SHPT-00-000531 - SharePoint sites must not use NTLM - SharePoint sites must not use NTLM."
  info        : "An authentication process resists replay attacks if it is impractical to achieve a successful authentication by recording and replaying a previous authentication message. Techniques used to address this include protocols using nonce's or challenges (e.g., TLS, WS_Security), and time synchronous or challenge-response one-time authenticators.

SharePoint must not use NTLM in the authentication process.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "1. Using IIS Manager (IIS 7), navigate to view the SharePoint Web Application sites.
2. Select a SharePoint Web Application site to configure.
3. In the IIS section, double-click Authentication and select Windows Authentication.
4. Right-click Windows Authentication and select Providers.
5. Add Negotiate to the list in the Enabled Providers box.
6. Remove NTLM from the list in the Enabled Providers box."
  reference   : "8500.2|IAIA-1,8500.2|IAIA-2,CAT|II,CCI|CCI-001941,Rule-ID|SV-37822r3_rule,STIG-ID|SHPT-00-000531,Vuln-ID|V-29301"
  see_also    : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
</report>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000191 - SharePoint farm service account (Database Access account) must be configured with minimum privileges in Active Directory (AD)."
  info                    : "Separation of duties is a prevalent Information Technology control implemented at different layers of the information system including the operating system and in applications. It serves to eliminate or reduce the possibility that a single user may carry out a prohibited action. Separation of duties requires the person accountable for approving an action not be the same person who is tasked with implementing the action.

This requirement is intended to limit exposure due to user accounts being used to operate from within a privileged account or role. Limiting the access and permissions of privileged accounts to the minimum required, reduces exposure if the account is compromised and provides forensic history of activity when operating from these accounts.

This policy limits the Farm Account privileges in AD.  However, default permissions for this account are configured by the SharePoint Products Configuration Wizard during product installation. This account is referred to during the installation as the 'Database Access' account. By default, the account is used as the service account for the SharePoint Timer Service and the SharePoint Central Administration Web Site Application Pool. These settings should not be changed. Furthermore, this account should not be used as the service account for non-privileged services, applications, or application pools.

See TechNet Article cc678863 for information regarding required permission. The server farm account requires membership in the Domain Users group in Active Directory."
  solution                : "Ensure the farm service account has minimum permissions in Active Directory.
1. Navigate to Active Directory Users and Computers -> Users.
2. Double click on the account to view the account properties.
3. Select the Members of tab to view group membership for this account.
4. Remove this account from membership in groups other than Domain Users."
  reference               : "800-171|3.1.5,800-53|AC-6,8500.2|ECLP-1,CAT|II,CCI|CCI-000225,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.10.6(a),CN-L3|8.1.4.2(d),CSF|PR.AC-4,CSF|PR.DS-5,ITSG-33|AC-6,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,Rule-ID|SV-37832r2_rule,STIG-ID|SHPT-00-000191,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3,Vuln-ID|V-29306"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
# Note: Variable @FARM_SVC_ACCT@ replaced with "farmsvcaccount" in field "powershell_args".
  powershell_args         : 'Get-WmiObject -Query \\"SELECT * FROM Win32_GroupUser WHERE PartComponent=`\\"Win32_SystemAccount.Domain=\'$env:userdomain\',Name=\'farmsvcaccount\'`\\" AND GroupComponent!=`\\"Win32_Group.Domain=\'$env:userdomain\',Name=\'Domain Users\'`\\"\\" | Select-Object PartComponent,GroupComponent | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000682 - The Online Web Part Gallery must be configured for limited access."
  info                    : "Web Part galleries are groupings of Web Parts. There are four Web Part galleries: Closed Web Parts, Site Name Gallery, Server Gallery, and Online Gallery. The Online Gallery is a collection of Microsoft MSNBC Web Parts located on the Internet. Allowing users to access the Online Web Part Gallery causes a significant performance hit on the server, due to the server attempting to connect to the MSNBC online gallery. This could result in a Denial-of-Service. The Online Gallery could contain Web Parts from unknown third parties, which could increase the risk of a malicious code execution attack. Preventing users from accessing the Online Web Part Gallery decreases the system's attack surface."
  solution                : "Enable the 'Prevents users from accessing the Online Web Part Gallery, and helps to improve security and performance' option for each web application.
1. In Central Administration, click Security.
2. On the Security page, in the General Security list, click Manage web part security.
3 On the Security for Web Part Pages page, for each web application in the web application section, perform the following:
- Select a web application in the Web Application list.
- In the Online Web Part Gallery section, select the 'Prevents users from accessing the Online Web Part Gallery, and helps to improve security and performance'.
4. Click OK."
  reference               : "800-171|3.1.5,800-53|AC-6,8500.2|ECCR-2,CAT|II,CCI|CCI-001167,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.10.6(a),CN-L3|8.1.4.2(d),CSF|PR.AC-4,CSF|PR.DS-5,ITSG-33|AC-6,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,Rule-ID|SV-37994r2_rule,STIG-ID|SHPT-00-000682,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3,Vuln-ID|V-29338"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.AllowAccessToWebPartCatalog -eq 1} | select DisplayName,AllowAccessToWebPartCatalog | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000683 - SharePoint-specific malware (i.e., anti-virus) software must be integrated and configured - 'Scan Documents on Upload is enabled'"
  info                    : "Configuring anti-virus settings ensures documents will be scanned for viruses upon download from and upload to the SharePoint server. Anti-virus settings are not configured by default, therefore leaving SharePoint document libraries open to potential viruses."
  solution                : "Install and configure anti-virus package.
1. Install a SharePoint specific antivirus solution.
2. In SharePoint Central Administration, click Security.
3. On the Security page, in the General Security list, click Manage antivirus settings.
4. Check the boxes for the following:
- Scan documents on upload.
- Scan documents on download.
- Attempt to clean infected documents.
5. Click OK."
  reference               : "800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-53|SI-3,8500.2|ECCR-2,CAT|I,CCI|CCI-001167,CN-L3|7.1.3.6(a),CN-L3|7.1.3.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CSF|DE.CM-4,CSF|DE.DP-3,ISO/IEC-27001|A.12.2.1,ITSG-33|SI-3,NESA|T3.4.1,NIAv2|GS10b,NIAv2|GS8a,NIAv2|IE11,NIAv2|SU7,Rule-ID|SV-37995r3_rule,STIG-ID|SHPT-00-000683,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7,Vuln-ID|V-29339"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : '[Microsoft.SharePoint.Administration.SPWebService]::ContentService | select -ExpandProperty AntivirusSettings | Where-Object {$_.UploadScanEnabled -ne 1} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000683 - SharePoint-specific malware (i.e., anti-virus) software must be integrated and configured - 'Scan Documents on Download is enabled'"
  info                    : "Configuring anti-virus settings ensures documents will be scanned for viruses upon download from and upload to the SharePoint server. Anti-virus settings are not configured by default, therefore leaving SharePoint document libraries open to potential viruses."
  solution                : "Install and configure anti-virus package.
1. Install a SharePoint specific antivirus solution.
2. In SharePoint Central Administration, click Security.
3. On the Security page, in the General Security list, click Manage antivirus settings.
4. Check the boxes for the following:
- Scan documents on upload.
- Scan documents on download.
- Attempt to clean infected documents.
5. Click OK."
  reference               : "800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-53|SI-3,8500.2|ECCR-2,CAT|I,CCI|CCI-001167,CN-L3|7.1.3.6(a),CN-L3|7.1.3.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CSF|DE.CM-4,CSF|DE.DP-3,ISO/IEC-27001|A.12.2.1,ITSG-33|SI-3,NESA|T3.4.1,NIAv2|GS10b,NIAv2|GS8a,NIAv2|IE11,NIAv2|SU7,Rule-ID|SV-37995r3_rule,STIG-ID|SHPT-00-000683,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7,Vuln-ID|V-29339"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : '[Microsoft.SharePoint.Administration.SPWebService]::ContentService | select -ExpandProperty AntivirusSettings | Where-Object {$_.DownloadScanEnabled -ne 1} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000683 - SharePoint-specific malware (i.e., anti-virus) software must be integrated and configured."
  info                    : "Configuring anti-virus settings ensures documents will be scanned for viruses upon download from and upload to the SharePoint server. Anti-virus settings are not configured by default, therefore leaving SharePoint document libraries open to potential viruses."
  solution                : "Install and configure anti-virus package.
1. Install a SharePoint specific antivirus solution.
2. In SharePoint Central Administration, click Security.
3. On the Security page, in the General Security list, click Manage antivirus settings.
4. Check the boxes for the following:
- Scan documents on upload.
- Scan documents on download.
- Attempt to clean infected documents.
5. Click OK."
  reference               : "800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-53|SI-3,8500.2|ECCR-2,CAT|I,CCI|CCI-001167,CN-L3|7.1.3.6(a),CN-L3|7.1.3.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CSF|DE.CM-4,CSF|DE.DP-3,ISO/IEC-27001|A.12.2.1,ITSG-33|SI-3,NESA|T3.4.1,NIAv2|GS10b,NIAv2|GS8a,NIAv2|IE11,NIAv2|SU7,Rule-ID|SV-37995r3_rule,STIG-ID|SHPT-00-000683,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7,Vuln-ID|V-29339"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : '[Microsoft.SharePoint.Administration.SPWebService]::ContentService | select -ExpandProperty AntivirusSettings | Where-Object {$_.CleaningEnabled -ne 1} | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000127 - The 'Automatically delete the site collection if use is not confirmed' property must not be enabled for web applications."
  info                    : "Automatic deletion is an administrative feature that can delete unused sites without administrative intervention and without a backup mechanism. Automatic deletion permanently removes all content and information from the site collection and any sites beneath it. If the site collection administrator or secondary site collection administrator fails to confirm a site is still in use when receiving an email notification asking if the site is still in use, the site is automatically deleted. This could result in a Denial-of-Service to the users of that site. Also, data could be lost if a backup was not made prior to removing the site collection."
  solution                : "Disable the 'Automatically delete the site collection if use is not confirmed' property for each web application.

1. In Central Administration, click Application Management.
2. On the Application Management page, in the Site Collections list, click Confirm site use and deletion.
3. Repeat the following steps for each web application:
- Select the web application.
- Deselect the 'Automatically delete the site collection  if use is not confirmed' checkbox."
  reference               : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,8500.2|EBBD-1,8500.2|EBBD-2,8500.2|EBBD-3,CAT|II,CCI|CCI-000381,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,Rule-ID|SV-38109r2_rule,STIG-ID|SHPT-00-000127,SWIFT-CSCv1|2.3,Vuln-ID|V-29363"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication | Where-Object {$_.AutomaticallyDeleteUnusedSiteCollections -eq 1} | select DisplayName,AutomaticallyDeleteUnusedSiteCollections | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000692 - Access to Central Administration site must be limited to authorized users and groups."
  info                    : "SharePoint must prevent the presentation of information system management-related functionality at an interface utilized by general, (i.e., non-privileged), users administrative interfaces to non-privileged users.

Information system management functionality includes: functions necessary to administer databases, network components, workstations, or servers, and typically requires privileged user access. The separation of user functionality from information system management functionality is either physical or logical and is accomplished by using different computers, different central processing units, different instances of the operating system, different network addresses, combinations of these methods, or other methods as appropriate. An example of this type of separation is observed in web administrative interfaces that use separate authentication methods for users of any other information system resources. This may include isolating the administrative interface on a different domain and with additional access controls. The Central Administrator is the web application used to manage SharePoint system configuration and web application settings."
  solution                : "1. Open Central Administration.
2. Select Site Actions > Site Permissions.
3. Remove all users and groups not on the organizationally defined list maintained by the IAO."
  reference               : "800-171|3.1.5,800-53|AC-6(1),8500.2|DCPA-1,CAT|II,CCI|CCI-001083,CSF|PR.AC-4,ISO/IEC-27001|A.9.4.4,ITSG-33|AC-6(1),NESA|T5.1.1,NESA|T5.4.4,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|VL3b,Rule-ID|SV-38129r2_rule,STIG-ID|SHPT-00-000692,SWIFT-CSCv1|5.1,Vuln-ID|V-29367"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPWebApplication -IncludeCentralAdministration | Where-Object {$_.IsAdministrationWebApplication} | Get-SPWeb -site {$_.Url} | select Title,SiteUsers | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000197 - A secondary site collection administrator must be defined when creating a new site collection."
  info                    : "If a site reaches its maximum size, users will be denied access until an administrator fixes the problem. Having a secondary administrator reduces the risk of having a Denial-of-Service on a site. If the site reaches its maximum size, the secondary administrator can fix the problem if the primary administrator is not available. In some situations, having a secondary site administrator could be inappropriate for reasons of control or confidentiality."
  solution                : "1. In SharePoint Central Administration, click Application Management.
2. On the Application Management page, in the Site Collections list, click Change site collection administrators.
4. For each Site Collection, define a Secondary Site Collection Administrator unless the site collection is for mySites.
5. Select OK."
  reference               : "800-171|3.5.3,800-53|IA-2(1),8500.2|ECLP-1,CAT|III,CCI|CCI-000366,CN-L3|7.1.2.7(b),CSF|PR.AC-1,ITSG-33|IA-2(1),NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,Rule-ID|SV-38149r2_rule,STIG-ID|SHPT-00-000197,SWIFT-CSCv1|1.2,Vuln-ID|V-29373"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : "Get-SPSite | Where-Object {$_.SecondaryContact.LoginName -eq $null} | select url | Format-List"
  powershell_option       : CAN_BE_NULL
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000199 - SharePoint service accounts must be configured for separation of duties."
  info                    : "Separation of duties is a prevalent Information Technology control implemented at different layers of the information system including the operating system and in applications. It serves to eliminate or reduce the possibility that a single user may carry out a prohibited action.

SharePoint service accounts must be configured for separation of duties, particularly the farm services account which should not be used to manage other services.  The required service accounts must be created in AD (default users group member only).  These AD accounts are applied when installing and configuring SharePoint services. If the default Farm Services Account is used for all services during initial configuration, this must be changed when each service is configured.  This violates the principles of least privilege since not all services have equal trust levels. Some services, (e.g., Excel Service or Search Service), may be configured to interact with outside resources. Microsoft recommends separate accounts for each service with the minimum required privileges for each service account.

When each service is installed, a service account is requested by the application. Ensure one service account is not used for all services. Either use separate accounts for all services or group the services based on trust and access privileges. Each account will be a member of the default user domain group in AD. The exact services installed on each farm may vary."
  solution                : "1. In SharePoint Central Administration, click Security.
2. On the Security page, in the General Security list, click Configure service accounts.
3. On the Service Accounts page, in the Credential Management section, select each service installed, and configure the service account field by selecting the appropriate AD account from the drop-down menu.
4. Create separate accounts for each service (or assign accounts based on common access permissions or trust levels)."
  reference               : "800-171|3.1.4,800-53|AC-5,8500.2|ECLP-1,CAT|II,CCI|CCI-002220,CSF|PR.DS-5,ISO/IEC-27001|A.6.1.2,ITSG-33|AC-5,NESA|T5.1.1,Rule-ID|SV-38296r2_rule,STIG-ID|SHPT-00-000199,SWIFT-CSCv1|5.1,Vuln-ID|V-29398"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
  powershell_args         : 'Get-SPFarm | Select-Object -ExpandProperty Services | Where-Object {$_.ProcessIdentity} | Select-Object -ExpandProperty ProcessIdentity | Where-Object {$_.Parent} | Select-Object Parent,Username | Format-List'
  only_show_cmd_output    : YES
</custom_item>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000193 - The SharePoint setup user domain account must be configured with the minimum privileges in Active Directory."
  info                    : "Separation of duties is a prevalent Information Technology control implemented at different layers of the information system including the operating system and in applications. It serves to eliminate or reduce the possibility that a single user may carry out a prohibited action. Separation of duties requires the person accountable for approving an action not be the same person tasked with implementing the action.

This requirement is intended to limit exposure due to users (or entities acting on behalf of users) being used to operate from within a privileged account or role. Limiting the access and permissions of privileged accounts to the minimum required, reduces exposure if the account is compromised and provides forensic history of activity when operating from these accounts.

See TechNet Article cc678863 for information regarding required permission. The setup user administrator account is used during initial creation of the farm, to update the farm servers, and to configure certain farm configuration option. The setup user administrator account should be limited to membership in the Domain Users group in Active Directory."
  solution                : "Ensure the Setup User domain user has minimum permissions in Active Directory.
1. Navigate to Active Directory Users and Computers -> Users.
2. Double click on the account to view the account properties.
3. Select the Members of tab to view group membership for this account.
4. Remove this account from membership in groups other than Domain Users."
  reference               : "800-171|3.1.5,800-53|AC-6,8500.2|ECLP-1,CAT|II,CCI|CCI-000225,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.10.6(a),CN-L3|8.1.4.2(d),CSF|PR.AC-4,CSF|PR.DS-5,ITSG-33|AC-6,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,Rule-ID|SV-38299r2_rule,STIG-ID|SHPT-00-000193,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3,Vuln-ID|V-29399"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
# Note: Variable @DOM_SP_SETUP_ACCT@ replaced with "domainsharepointsetupaccount" in field "powershell_args".
  powershell_args         : 'Get-WmiObject -Query \\"SELECT * FROM Win32_GroupUser WHERE PartComponent=`\\"Win32_SystemAccount.Domain=\'$env:userdomain\',Name=\'domainsharepointsetupaccount\'`\\" AND GroupComponent!=`\\"Win32_Group.Domain=\'$env:userdomain\',Name=\'Domain Users\'`\\"\\" | Select-Object PartComponent,GroupComponent | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint LogLocation defined"
      value_type              : POLICY_TEXT
      value_data              : "LogLocation[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPDiagnosticConfig | select LogLocation | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000431 - SharePoint must protect audit information from unauthorized access to the trace data log files."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is difficult. To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized access.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change the directory permissions where trace data logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the Path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000162,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-39935r2_rule,STIG-ID|SHPT-00-000431,SWIFT-CSCv1|5.1,Vuln-ID|V-30282"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPDiagnosticConfig | select LogLocation -ExpandProperty LogLocation; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000431 - SharePoint must protect audit information from unauthorized access to the trace data log files."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is difficult. To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized access.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change the directory permissions where trace data logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the Path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-53|AU-4,8500.2|ECTP-1,CAT|II,CCI|CCI-000162,CSF|PR.DS-4,CSF|PR.PT-1,ITSG-33|AU-4,NESA|T3.3.1,NESA|T3.6.2,Rule-ID|SV-39935r2_rule,STIG-ID|SHPT-00-000431,Vuln-ID|V-30282"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPDiagnosticConfig | select LogLocation | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint LogLocation defined"
      value_type              : POLICY_TEXT
      value_data              : "LogLocation[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000436 - SharePoint must protect audit information from unauthorized modification to trace data logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized modification.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database. Only designated audit administrators and internal accounts should have any type of permission to these files."
      solution                : "Change permissions to the directory where trace logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000163,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-39940r2_rule,STIG-ID|SHPT-00-000436,SWIFT-CSCv1|5.1,Vuln-ID|V-30287"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPDiagnosticConfig | select LogLocation -ExpandProperty LogLocation; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000436 - SharePoint must protect audit information from unauthorized modification to trace data logs."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized modification.

SharePoint is an integrated product with comprehensive built-in auditing capabilities working with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database. Only designated audit administrators and internal accounts should have any type of permission to these files."
      solution                : "Change permissions to the directory where trace logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-53|AU-4,8500.2|ECTP-1,CAT|II,CCI|CCI-000163,CSF|PR.DS-4,CSF|PR.PT-1,ITSG-33|AU-4,NESA|T3.3.1,NESA|T3.6.2,Rule-ID|SV-39940r2_rule,STIG-ID|SHPT-00-000436,Vuln-ID|V-30287"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPDiagnosticConfig | select LogLocation | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<if>
  <condition type:"AND">
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SharePoint LogLocation defined"
      value_type              : POLICY_TEXT
      value_data              : "LogLocation[\s]*:[\s]*[%A-Za-z:\\]*[%A-Za-z0-9 \\_-]+"
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPUsageService | select UsageLogDir | Format-List'
      check_type              : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000441 - SharePoint must protect audit information from unauthorized deletion of trace log files."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized deletion.

SharePoint is an integrated product with comprehensive built-in auditing capabilities that works with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where trace data logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the Path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-171|3.3.8,800-171|3.3.9,800-53|AU-9(4),8500.2|ECTP-1,CAT|II,CCI|CCI-000164,CN-L3|8.1.4.3(d),CSF|PR.PT-1,ITSG-33|AU-9(4),NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,Rule-ID|SV-39943r2_rule,STIG-ID|SHPT-00-000441,SWIFT-CSCv1|5.1,Vuln-ID|V-30290"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : '$a = Get-SPDiagnosticConfig | select LogLocation -ExpandProperty LogLocation; if($a.IndexOf(\\"%\\") -eq 0) {$b=[System.Environment]::ExpandEnvironmentVariables($a);Get-Acl -Path \\"$b\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List} Else {Get-Acl -Path \\"$a\\" | ForEach-Object {$_.Access} | Group-Object IdentityReference | Where-Object {$_.Name -notmatch \\"system\\" -and $_.Name -notmatch \\"administrators\\" -and $_.Name -notlike \\"*\\LOCAL SERVICE\\" -and $_.Name -notlike \\"*\\WSS_ADMIN_WPG\\" -and $_.Name -notlike \\"*\\WSS_WPG\\" -and $_.Name -notlike \\"*\\WSS_RESTRICTED_WPG_V4\\"}|Select Name|Format-List}'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <custom_item>
      type                    : AUDIT_POWERSHELL
      description             : "SHPT-00-000441 - SharePoint must protect audit information from unauthorized deletion of trace log files."
      info                    : "If audit data were to become compromised then competent forensic analysis and discovery of the true source of potentially malicious system activity is impossible to achieve.

To ensure the veracity of audit data the information system and/or SharePoint must protect audit information from unauthorized deletion.

SharePoint is an integrated product with comprehensive built-in auditing capabilities that works with the Windows system event log. Additional trace logs and usage logs are created by the application and are placed in a designated folder. Logs of actions taken by users of site content (editing, modifying, viewing, deleting, etc.) are stored in a SQL database."
      solution                : "Change permissions to the directory where trace data logs are stored.
1. In Central Administration, click Monitoring.
2. On the Monitoring page, in the Reporting list, click Configure diagnostic logging.
3. Obtain the Path location for the Trace Log.
4. Navigate to the file location, right-click, and select Properties. View the Security tab.
5. Delete any groups or users other than the LOCAL SERVICE, WSS_ADMIN_WPG, WSS_RESTRICTED_WPG_V4, WSS_WPG, local Administrators group, and SYSTEM group from the permissions list."
      reference               : "800-53|AU-4,8500.2|ECTP-1,CAT|II,CCI|CCI-000164,CSF|PR.DS-4,CSF|PR.PT-1,ITSG-33|AU-4,NESA|T3.3.1,NESA|T3.6.2,Rule-ID|SV-39943r2_rule,STIG-ID|SHPT-00-000441,Vuln-ID|V-30290"
      see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
      value_type              : POLICY_TEXT
      value_data              : ""
      powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
      powershell_args         : 'Get-SPDiagnosticConfig | select LogLocation | Format-List'
      powershell_option       : CAN_BE_NULL
    </custom_item>
  </else>
</if>

<custom_item>
  type                    : AUDIT_POWERSHELL
  description             : "SHPT-00-000195 - The SharePoint setup user domain account must be configured with the minimum privileges for the local server."
  info                    : "Separation of duties is a prevalent Information Technology control implemented at different layers of the information system including the operating system and in applications. It serves to eliminate or reduce the possibility that a single user may carry out a prohibited action. Separation of duties requires the person accountable for approving an action not be the same person tasked with implementing the action.

This requirement is intended to limit exposure due to users (or entities acting on behalf of users) being used to operate from within a privileged account or role. Limiting the access and permissions of privileged accounts to the minimum required, reduces exposure if the account is compromised and provides forensic history of activity when operating from these accounts.

See TechNet Article cc678863 for information regarding required permission. The setup user administrator account is used during initial creation of the farm, to update the farm servers, and to configure certain farm configuration option. The setup user administrator account must have membership in the local administrators Windows group on each server in the farm (excluding SQL Server and the Exchange server.)"
  solution                : "1. On the server (s) where the SharePoint software is installed, navigate to Server Manager -> Local Users and Groups -> Groups.
2. Double-click on each group to view membership.
3. Remove the SharePoint setup user account from membership in groups other than Administrators and WSS_ADMIN_WPG."
  reference               : "800-171|3.1.1,800-53|AC-2,8500.2|ECLP-1,CAT|II,CCI|CCI-000225,CN-L3|7.1.3.2(d),CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,ISO/IEC-27001|A.9.2.1,ITSG-33|AC-2,NESA|T5.2.1,NESA|T5.2.2,NIAv2|AM28,NIAv2|NS5j,NIAv2|SS14e,Rule-ID|SV-40025r2_rule,STIG-ID|SHPT-00-000195,Vuln-ID|V-30366"
  see_also                : "https://iasecontent.disa.mil/stigs/zip/U_MS_SharePoint_2010_V1R9_STIG.zip"
  value_type              : POLICY_TEXT
  value_data              : ""
  powershell_console_file : "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\CONFIG\POWERSHELL\Registration\psconsole.psc1"
# Note: Variable @LOC_SP_SETUP_ACCT@ replaced with "localsharepointsetupaccount" in field "powershell_args".
  powershell_args         : 'Get-WmiObject -Query \\"SELECT * FROM Win32_GroupUser WHERE PartComponent=`\\"Win32_SystemAccount.Domain=\'$env:userdomain\',Name=\'localsharepointsetupaccount\'`\\" AND GroupComponent!=`\\"Win32_Group.Domain=\'$env:userdomain\',Name=\'Administrators\'`\\" AND GroupComponent!=`\\"Win32_Group.Domain=\'$env:userdomain\',Name=\'WSS_ADMIN_WPG\'`\\"\\"  | Select-Object PartComponent,GroupComponent | Format-List'
  powershell_option       : CAN_BE_NULL
</custom_item>

</group_policy>
</check_type>
