#
# This script is Copyright (C) 2004-2020 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
#
# $Revision: 1.4 $
# $Date: 2020/07/14 $
#
# description : This document implements the security configuration as recommended by the
#               CIS Apple macOS 10.13 Benchmark v1.0.0
#
#               https://workbench.cisecurity.org/files/2105
#
#<ui_metadata>
#<display_name>CIS Apple macOS 10.13 L2 v1.0.0</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Apple macOS 10.13 L2</name>
#  <version>1.0.0</version>
#  <link>https://workbench.cisecurity.org/files/2105</link>
#</spec>
#<labels>unix,cis,macosx,macosx_10,macosx_10.13,agent</labels>
#<benchmark_refs>LEVEL</benchmark_refs>
#<variables>
#  <variable>
#    <name>BANNER_TEXT</name>
#    <default>All activities performed on this system will be monitored.</default>
#    <description>Banner Text</description>
#    <info>This is the text for the warning a user receives when logging onto the system.</info>
#  </variable>
#</variables>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : CMD_EXEC
      description : "MacOS 10.13 is installed"
      cmd         : "/usr/bin/sw_vers | /usr/bin/grep 'ProductVersion'"
      expect      : "^ProductVersion[\\s]*:[\\s]*10\.13"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "CIS_Apple_macOS_10.13_v1.0.0_Level_2.audit from CIS Apple macOS 10.13 Benchmark v1.0.0"
    </report>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - top right corner"
      info         : "Hot Corners can be configured to disable the screen saver by moving the mouse cursor to a corner of the screen.

Rationale:

Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select Mission Control
3. Select Hot Corners
4. Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      not_regex    : ".* = 6"
      plist_item   : "wvous-tr-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - top left corner"
      info         : "Hot Corners can be configured to disable the screen saver by moving the mouse cursor to a corner of the screen.

Rationale:

Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select Mission Control
3. Select Hot Corners
4. Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      not_regex    : ".* = 6"
      plist_item   : "wvous-tl-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - bottom left corner"
      info         : "Hot Corners can be configured to disable the screen saver by moving the mouse cursor to a corner of the screen.

Rationale:

Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select Mission Control
3. Select Hot Corners
4. Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      not_regex    : ".* = 6"
      plist_item   : "wvous-bl-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - bottom right corner"
      info         : "Hot Corners can be configured to disable the screen saver by moving the mouse cursor to a corner of the screen.

Rationale:

Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select Mission Control
3. Select Hot Corners
4. Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      not_regex    : ".* = 6"
      plist_item   : "wvous-br-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.6.6 Enable Location Services"
      info        : "macOS uses location information gathered through local Wi-Fi networks to enable applications to supply relevant information to users. Users do not need to change the time or the time zone, the computer will do it for them. They do not need to specify their location for weather or travel times and even get alerts on travel times to meetings and appointment where location information is supplied.

For the purpose of asset management and time and log management with mobile computers location services simplify some processes.

There are some use cases where it is important that the computer not be able to report it's exact location. While the general use case is to enable Location Services, it should not be allowed if the physical location of the computer and the user should not be public knowledge.

https://support.apple.com/en-us/HT204690

Rationale:

Location services are helpful in most use cases and can simplify log and time management where computers change time zones."
      solution    : "Perform the following to ensure the system is configured as prescribed:

1. In Terminal, run the following command:

sudo launchctl load /System/Library/LaunchDaemons/com.apple.locationd.plist

2. There should be no response

In some use cases organizations may not want Location Services running in those cases 'unload' rather than 'load' is the appropriate command

Perform the following to ensure the system is configured as prescribed:

1. In Terminal, run the following command:

sudo launchctl unload /System/Library/LaunchDaemons/com.apple.locationd.plist

2. Verify that the results include: Could not find specified service"
      reference   : "800-53|CM-8(8),CSF|DE.CM-7,CSF|PR.DS-3,LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/bin/launchctl load /System/Library/LaunchDaemons/com\.apple\.locationd\.plist"
      expect      : "(Operation[\\s]+already[\\s]+in[\\s]+progress|service[\\s]+already[\\s]+loaded)"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.6.7 Monitor Location Services Access"
      info         : "macOS uses location information gathered through local Wi-Fi networks to enable applications to supply relevant information to users. While location services may be very useful it may not be desirable to allow all applications that can use location services to use your location for Internet queries to provide tailored content based on your current location.

Ensure that the applications that can use Location Services are authorized to use that information and provide that information where the application interacts with external systems. Apple provides feedback within System Preferences and may be enabled to provide information on the menu bar when Location Services are used.

Safari can deny access from websites or prompt for access.

Applications that support Location Services can be individually controlled in the Privacy tab in Security & Privacy under System Preferences.

Access should be evaluated to ensure that privacy controls are as expected.

Rationale:

Privacy controls should be monitored for appropriate settings"
      solution     : "Safari Configuration

Perform the following to implement the prescribed state:

1. Open Safari
2. Select Safari from the menu bar
3. Select Websites
4. Select Location
5. When visiting other websites should be set to Ask or Deny

Perform the following to review applications in System Preferences:

1. Open System Preferences
2. Select Security & Privacy
3. Select Privacy
4. Select Location Services
5. Uncheck applications that are not approved for access to location service information"
      reference    : "800-53|CM-8(8),CSF|DE.CM-7,CSF|PR.DS-3,LEVEL|2NS"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      regex        : "0|1"
      plist_item   : "SafariGeolocationPermissionPolicy globalstate"
      plist_name   : "/Library/Preferences/com.apple.safari.plist"
      plist_option : CAN_BE_NULL
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.6.7 Monitor Location Services Access - evaluate application"
      info        : "macOS uses location information gathered through local Wi-Fi networks to enable applications to supply relevant information to users. While location services may be very useful it may not be desirable to allow all applications that can use location services to use your location for Internet queries to provide tailored content based on your current location.

Ensure that the applications that can use Location Services are authorized to use that information and provide that information where the application interacts with external systems. Apple provides feedback within System Preferences and may be enabled to provide information on the menu bar when Location Services are used.

Safari can deny access from websites or prompt for access.

Applications that support Location Services can be individually controlled in the Privacy tab in Security & Privacy under System Preferences.

Access should be evaluated to ensure that privacy controls are as expected.

Rationale:

Privacy controls should be monitored for appropriate settings

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution    : "Safari Configuration

Perform the following to implement the prescribed state:

1. Open Safari
2. Select Safari from the menu bar
3. Select Websites
4. Select Location
5. When visiting other websites should be set to Ask or Deny

Perform the following to review applications in System Preferences:

1. Open System Preferences
2. Select Security & Privacy
3. Select Privacy
4. Select Location Services
5. Uncheck applications that are not approved for access to location service information"
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-6,CN-L3|7.1.3.3(d),CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.DP-4,CSF|PR.PT-1,CSF|RS.AN-1,CSF|RS.CO-2,ITSG-33|AU-6,LEVEL|2NS,NESA|M5.2.5,NESA|T3.6.3,NESA|T3.6.6,NESA|T8.3.2,SWIFT-CSCv1|6.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/defaults read /var/db/locationd/clients.plist | /usr/bin/grep -i com.*"
      expect      : ""
      severity    : MEDIUM
    </custom_item>

    <report type:"WARNING">
      description : "2.6.8 Disable sending diagnostic and usage data to Apple"
      info        : "Apple provides a mechanism to send diagnostic and usage data back to Apple to help them improve the platform. Diagnostics and usage information may contain internal organizational information that should be controlled and not available for processing by Apple.
Turn off Share Mac Analytics.

Rationale:

Organizations should have knowledge of what is shared with the vendor and the setting automatically forwards information to Apple.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select Security & Privacy
3. Select Privacy
4. Select Analytics
5. Deselect 'Share Mac Analytics'"
      reference   : "LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "2.7.1 iCloud configuration"
      info        : "Apple's iCloud is a consumer oriented service that allows a user to store data as well as find, control and backup devices that are associated with their Apple ID (Apple account.) The use of iCloud on Enterprise devices should align with the acceptable use policy for devices that are managed as well as confidentiality requirements for data handled by the user. If iCloud is allowed the data that is copied to Apple servers will likely be duplicated on both personal as well as Enterprise devices.

For many users the Enterprise email system may replace many of the available features in iCloud. If using either an Exchange or Google environment email, calendars, notes and contacts can sync to the official Enterprise repository and be available through multiple devices.

Depending on workplace requirements it may not be appropriate to intermingle Enterprise and personal bookmarks, photos and documents. Since the service allows every device associated with the users ID to synchronize and have access to the cloud storage the concern is not just about having sensitive data on Apple's servers but having that same data on the phone of the teenage son or daughter of an employee. The use of family sharing options can reduce the risk.

The remote connectivity of 'Back to My Mac' relies on screen sharing that should already be turned off, if available the users Apple ID (personal?) can be used for remote access to the Enterprise computer rather than through Enterprise managed accounts.

Apple's iCloud is just one of many cloud based solutions being used for data synchronization across multiple platforms and it should be controlled consistently with other cloud services in your environment. Work with your employees and configure the access to best enable data protection for your mission.

Rationale:

Organizations must make a risk decision on how their computers will interact with public cloud services.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Disable unapproved services in System Preferences > iCloud.
Use a profile to disable services where organizationally required."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "2.7.2 iCloud keychain"
      info        : "The iCloud keychain is Apple's password manager that works with macOS and iOS. The capability allows users to store passwords in either iOS or macOS for use in Safari on both platforms and other iOS integrated applications. The most pervasive use is driven by iOS use rather than macOS. The passwords stored in a macOS keychain on an Enterprise managed computer could be stored in Apple's cloud and then be available on a personal computer using the same account. The stored passwords could be for organizational as well as for personal accounts.

If passwords are no longer being used as organizational tokens they are not in scope for iCloud keychain storage.

Rationale:

Ensure that the iCloud keychain is used consistently with organizational requirements

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Open System Preferences: iCloud and deselect Keychain if it is not approved in your organization."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "2.7.3 iCloud Drive"
      info        : "iCloud Drive is Apple's storage solution for applications on both macOS and iOS to use the same files that are resident in Apple's cloud storage. The iCloud Drive folder is available much like Dropbox, Microsoft OneDrive or Google Drive.

One of the concerns in public cloud storage is that proprietary data may be inappropriately stored in an end user's personal repository. Organizations that need specific controls on information should ensure that this service is turned off or the user knows what information must be stored on services that are approved for storage of controlled information.

Rationale:

Organizations should review third party storage solutions pertaining to existing data confidentiality and integrity requirements.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "If cloud storage is not allowed in your organization in System Preferences: iCloud uncheck iCloud Drive."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "2.7.4 iCloud Drive Document sync"
      info        : "With macOS 10.12 Apple introduced the capability to have a user's Documents folder automatically synchronize to the user's iCloud Drive, providing they have enough room purchased through Apple on their iCloud drive. This capability mirrors what Microsoft is doing with the use of OneDrive and Office 365. There are concerns with using this capability.

The storage space that Apple provides for free is used by users with iCloud mail, all of a user's Photo Library created with the ever larger Multi-Pixel iPhone cameras and all of the iOS Backups. Adding a synchronization capability for users who have files going back a decade or more and storage may be tight without much larger Apple charges than the free 5GB. Users with multiple computers running 10.12 and above with unique content on each will have issues as well.

Enterprise users may not be allowed to store Enterprise information in a third party public cloud. In previous implementations iCloud Drive or even DropBox the user selected what files were synchronized even if there were no other controls. The new feature synchronizes all files in a folder widely used to put working files.

The automatic synchronization of all files in a user's Documents folder should be disabled.

[https://derflounder.wordpress.com/2016/09/23/icloud-desktop-and-documents-in-macos-sierra-the-good-the-bad-and-the-ugly/](https://derflounder.wordpress.com/2016/09/23/icloud-desktop-and-documents-in-macos-sierra-the-good-the-bad-and-the-ugly/)

Rationale:

Automated Document synchronization should be planned and controlled to approved storage.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select iCloud
3. Select iCloud Drive
4. Select Options next to iCloud Drive
5. Uncheck Desktop & Documents Folders"
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2S,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/bin/ls -l ~/Library/Mobile\\ Documents/com~apple~CloudDocs/Documents/ | /usr/bin/wc -l"
      expect      : "[\\s]+0"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.7.5 iCloud Drive Desktop sync"
      info        : "With macOS 10.12 Apple introduced the capability to have a user's Desktop folder automatically synchronize to the user's iCloud Drive, providing they have enough room purchased through Apple on their iCloud drive. This capability mirrors what Microsoft is doing with the use of OneDrive and Office 365. There are concerns with using this capability.

The storage space that Apple provides for free is used by users with iCloud mail, all of a user's Photo Library created with the ever larger Multi-Pixel iPhone cameras and all of the iOS Backups. Adding a synchronization capability for users who have files going back a decade or more and storage may be tight without much larger Apple charges than the free 5GB. Users with multiple computers running 10.12 and above with unique content on each will have issues as well.

Enterprise Users may not be allowed to store Enterprise information in a third party public cloud. In previous implementations iCloud Drive or even DropBox the user selected what files were synchronized even if there were no other controls. The new features synchronize all files in a folder widely used to put working files.

The automatic synchronization of all files in a user's Desktop folder should be disabled

https://derflounder.wordpress.com/2016/09/23/icloud-desktop-and-documents-in-macos-sierra-the-good-the-bad-and-the-ugly/

Rationale:

Automated Desktop synchronization should be planned and controlled to approved storage."
      solution    : "Perform the following to implement the prescribed state:

1. Open System Preferences
2. Select iCloud
3. Select iCloud Drive
4. Select Options next to iCloud Drive
5. Uncheck Desktop & Documents Folders"
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2S,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/bin/ls -l ~/Library/Mobile\\ Documents/com~apple~CloudDocs/Desktop/ | /usr/bin/wc -l"
      expect      : "[\\s]+0"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.8.1 Time Machine Auto-Backup"
      info         : "Backup solutions are only effective if the backups run on a regular basis. The time to check for backups is before the hard drive fails or the computer goes missing. In order to simplify the user experience so that backups are more likely to occur Time Machine should be on and set to Back Up Automatically whenever the target volume is available.

Operational staff should ensure that backups complete on a regular basis and the backups are tested to ensure that file restoration from backup is possible when needed.

Backup dates are available even when the target volume is not available in the Time Machine plist.

SnapshotDates = (

 '2012-08-20 12:10:22 +0000',

 '2013-02-03 23:43:22 +0000',

 '2014-02-19 21:37:21 +0000',

 '2015-02-22 13:07:25 +0000',

 '2016-08-20 14:07:14 +0000'

When the backup volume is connected to the computer more extensive information is available through tmutil. See man tmutil

Rationale:

Backups should automatically run whenever the backup drive is available"
      solution     : "Perform the following to configure the system as prescribed:

1. Run the following command in Terminal:

defaults write /Library/Preferences/com.apple.TimeMachine.plist AutoBackup 1"
      reference    : "800-171|3.8.9,800-53|CP-9,CSF|PR.IP-4,ISO/IEC-27001|A.12.3.1,ITSG-33|CP-9,LEVEL|2S,NESA|M5.2.3,NESA|T2.2.4,NESA|T3.5.1"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      regex        : "[^0]+"
      plist_item   : "AutoBackup"
      plist_name   : "/Library/Preferences/com.apple.TimeMachine.plist"
      plist_option : CANNOT_BE_NULL
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.11 Java 6 is not the default Java runtime"
      info        : "Apple had made Java part of the core Operating System for macOS. Apple is no longer providing Java updates for macOS and updated JREs and JDK are made available by Oracle. The latest version of Java 6 made available by Apple has many unpatched vulnerabilities and should not be the default runtime for Java applets that request one from the Operating System

Rationale:

Java has been one of the most exploited environments and Java 6, which was provided as an OS component by Apple, is no longer maintained by Apple or Oracle. The old versions provided by Apple are both unsupported and missing the more modern security controls that have limited current exploits. The EOL version may still be installed and should be removed from the computer or not be in the default path."
      solution    : "Java 6 can be removed completely or, if required Java applications will only work with Java 6, a custom path can be used. Apple is likely to finally pull the plug on Java 6 in upcoming MacOS versions so any applications that still require Java 6 will likely soon be unavailable."
      reference   : "800-171|3.4.1,800-53|CM-8,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|PR.DS-3,ISO/IEC-27001|A.8.1.1,ITSG-33|CM-8,LEVEL|2S,NESA|T1.2.1,NESA|T1.2.2,NIAv2|NS35"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/java -version 2>&1 | /usr/bin/egrep -o '1\.[456]\.[^\"\) ]+' | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
      expect      : "none"
    </custom_item>

    <report type:"WARNING">
      description : "2.12 Securely delete files as needed"
      info        : "In previous versions of macOS Apple included a capability to securely empty the trash that included overwrites of the existing data. With the wider use of FileVault and other encryption methods and the growing use of Solid State Drives the requirements have changed and the 'Secure Empty Trash' capability has been removed from the GUI. For systems that are not using encryption and continue to use platter-based hard drives there is residual risk that deleted files can still be recovered from the file system.

In previous versions of the Benchmark srm was mentioned as an alternative to the removal of 'Secure Empty Trash.' With the release of macOS 10.12 srm has been removed. There is still an option to erase free space from the command line but Apple has warned that encryption is a better solution

From manual entry for diskutil

 NOTE: This kind of secure erase is no longer considered safe

 because modern devices have wear-leveling, block-sparing, and

 possibly-persistent cache hardware. The modern solution for

 quickly and securely erasing your data is strong encryption,

 with which mere destruction of the key more or less instantly

 renders your data irretrievable in practical terms.

To erase free space on the boot volume

diskutil secureErase freespace 0 /

Rationale:

Securely removing files mitigates the risk of an admin user on the system recovering sensitive files that the user has deleted. It is possible for anyone with physical access to the device to get access if FileVault is not used, or to recover deleted data if the FileVault volume is already mounted. Users and admins of computers containing sensitive information should be screened appropriately or additional security controls should be in place to prevent unauthorized access to sensitive information.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "800-53|CM-6,CSF|PR.IP-1,LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.2 Configure Security Auditing Flags - 'audit successful/failed login/logout events'"
      info        : "Auditing is the capture and maintenance of information about security-related events.

Rationale:

Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, have begun, or are about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:

1. Open a terminal session and edit the '/etc/security/audit_control file'
2. Find the line beginning with 'flags'
3. Add the following flags: 'lo', 'ad', 'fd', 'fm', '-all'.
4. Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*lo).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.2 Configure Security Auditing Flags - 'audit successful/failed administrative events'"
      info        : "Auditing is the capture and maintenance of information about security-related events.

Rationale:

Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, have begun, or are about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:

1. Open a terminal session and edit the '/etc/security/audit_control file'
2. Find the line beginning with 'flags'
3. Add the following flags: 'lo', 'ad', 'fd', 'fm', '-all'.
4. Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*ad).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.2 Configure Security Auditing Flags - 'audit successful/failed file deletion events'"
      info        : "Auditing is the capture and maintenance of information about security-related events.

Rationale:

Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, have begun, or are about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:

1. Open a terminal session and edit the '/etc/security/audit_control file'
2. Find the line beginning with 'flags'
3. Add the following flags: 'lo', 'ad', 'fd', 'fm', '-all'.
4. Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*fd).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.2 Configure Security Auditing Flags - 'audit successful/failed file attribute modification events'"
      info        : "Auditing is the capture and maintenance of information about security-related events.

Rationale:

Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, have begun, or are about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:

1. Open a terminal session and edit the '/etc/security/audit_control file'
2. Find the line beginning with 'flags'
3. Add the following flags: 'lo', 'ad', 'fd', 'fm', '-all'.
4. Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*fm).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.2 Configure Security Auditing Flags - 'audit all failed events across all audit classes'"
      info        : "Auditing is the capture and maintenance of information about security-related events.

Rationale:

Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, have begun, or are about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:

1. Open a terminal session and edit the '/etc/security/audit_control file'
2. Find the line beginning with 'flags'
3. Add the following flags: 'lo', 'ad', 'fd', 'fm', '-all'.
4. Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*-all).*$"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "4.1 Disable Bonjour advertising service"
      info         : "Bonjour is an auto-discovery mechanism for TCP/IP devices which enumerate devices and services within a local subnet. DNS on macOS is integrated with Bonjour and should not be turned off, but the Bonjour advertising service can be disabled.

Rationale:

Bonjour can simplify device discovery from an internal rogue or compromised host. An attacker could use Bonjour's multicast DNS feature to discover a vulnerable or poorly-configured service or additional information to aid a targeted attack. Implementing this control disables the continuous broadcasting of 'I'm here!' messages. Typical end-user endpoints should not have to advertise services to other computers. This setting does not stop the computer from sending out service discovery messages when looking for services on an internal subnet, if the computer is looking for a printer or server and using service discovery. To block all Bonjour traffic except to approved devices the pf or other firewall would be needed."
      solution     : "Perform the following to implement the prescribed state:

1. Run the following command in Terminal:

defaults write /Library/Preferences/com.apple.mDNSResponder.plist NoMulticastAdvertisements"
      reference    : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSCv6|9.2,CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2S,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,SWIFT-CSCv1|2.3"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      regex        : "1"
      plist_item   : "NoMulticastAdvertisements"
      plist_name   : "/Library/Preferences/com.apple.mDNSResponder.plist"
      plist_option : CAN_BE_NULL
    </custom_item>

    <report type:"WARNING">
      description : "4.3 Create network specific locations"
      info        : "The network location feature of the Mac is very powerful tool to manage network security. By creating different network locations, a user can easily (and without administrative privileges) change the network settings on the Mac. By only using the network interfaces needed at any specific time, exposure to network attacks is limited.

A little understanding of how the Network System Preferences pane works is required.

Rationale:

Network locations allow the computer to have specific configurations ready for network access when required. Locations can be used to manage which network interfaces are available for specialized network access

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Create multiple network locations as needed.

Delete the Automatic location for any device that does not use multiple network services set for DHCP or dynamic addressing. If network services like FireWire, VPN, AirPort or Ethernet are not used by a specific device class those services should be deleted:

1. Select Edit Locations from the Locations popup menu.
2. Select the Automatic location.
3. Click the minus button for any unneeded service."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "5.1.4 Check Library folder for world writable files"
      info        : "Software sometimes insists on being installed in the '/Library Directory' and have inappropriate world writable permissions.

Rationale:

Folders in '/Library' should not be world writable. The audit check excludes the '/Library/Caches' folder where the sticky bit is set."
      solution    : "Change permissions so that 'Others' can only execute. (Example Below)

sudo chmod -R o-w /Bad/Directory"
      reference   : "800-171|3.1.5,800-53|AC-6,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.10.6(a),CN-L3|8.1.4.2(d),CSF|PR.AC-4,CSF|PR.DS-5,ITSG-33|AC-6,LEVEL|2S,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,PCI-DSSv3.1|7.1.2,PCI-DSSv3.2|7.1.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/find /Library -type d -perm -2 -ls | /usr/bin/grep -v Caches | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
      expect      : "none"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.2.3 Complex passwords must contain an Alphabetic Character"
      info        : "Complex passwords contain one character from each of the following classes: English uppercase letters, English lowercase letters, Westernized Arabic numerals, and non-alphanumeric characters.

Ensure that an Alphabetic character is part of the password policy on the computer

Rationale:

The more complex a password the more resistant it will be against persons seeking unauthorized access to a system."
      solution    : "Perform the following to implement the prescribed state for all pwpolicy controls

1. Run the following command in Terminal:

pwpolicy -setaccountpolicies

Examples in pwpolicy man page"
      reference   : "800-171|3.5.7,800-53|IA-5(1),CIP|007-6-R5,CN-L3|7.1.2.7(e),CN-L3|7.1.3.1(b),CSF|PR.AC-1,HIPAA|164.308(a)(5)(ii)(D),ISO/IEC-27001|A.9.4.3,ITSG-33|IA-5(1),LEVEL|2NS,NESA|T5.2.3,NIAv2|AM19a,NIAv2|AM19b,NIAv2|AM19c,NIAv2|AM19d,NIAv2|AM22a,PCI-DSSv3.1|8.2.3,PCI-DSSv3.2|8.2.3,SWIFT-CSCv1|4.1,TBA-FIISB|26.2.1,TBA-FIISB|26.2.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/pwpolicy -getaccountpolicies | /usr/bin/egrep '(RequiresAlpha|minimumAlphaCharacters)'"
      expect      : "(RequiresAlpha|minimumAlphaCharacters)"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.2.4 Complex passwords must contain a Numeric Character"
      info        : "Complex passwords contain one character from each of the following classes: English uppercase letters, English lowercase letters, Westernized Arabic numerals, and non-alphanumeric characters.

Ensure that a number or numeric value is part of the password policy on the computer.

Rationale:

The more complex a password the more resistant it will be against persons seeking unauthorized access to a system."
      solution    : "Perform the following to implement the prescribed state for all pwpolicy controls

1. Run the following command in Terminal:

pwpolicy -setaccountpolicies

Examples in pwpolicy man page"
      reference   : "800-171|3.5.7,800-53|IA-5(1),CN-L3|7.1.2.7(e),CN-L3|7.1.3.1(b),CSF|PR.AC-1,ISO/IEC-27001|A.9.4.3,ITSG-33|IA-5(1),LEVEL|2NS,NESA|T5.2.3,NIAv2|AM19a,NIAv2|AM19b,NIAv2|AM19c,NIAv2|AM19d,NIAv2|AM22a,SWIFT-CSCv1|4.1,TBA-FIISB|26.2.1,TBA-FIISB|26.2.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/pwpolicy -getaccountpolicies | /usr/bin/egrep '(RequiresNumeric|minimumNumericCharacters)'"
      expect      : "(RequiresNumeric|minimumNumericCharacters)"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.2.5 Complex passwords must contain a Special Character"
      info        : "Complex passwords contain one character from each of the following classes: English uppercase letters, English lowercase letters, Westernized Arabic numerals, and non-alphanumeric characters. Ensure that a special character is part of the password policy on the computer

Rationale:

The more complex a password the more resistant it will be against persons seeking unauthorized access to a system."
      solution    : "Perform the following to implement the prescribed state for all pwpolicy controls

1. Run the following command in Terminal:

pwpolicy -setaccountpolicies

Examples in pwpolicy man page"
      reference   : "800-171|3.5.7,800-53|IA-5,CN-L3|7.1.2.7(e),CN-L3|7.1.3.1(b),CSF|PR.AC-1,ISO/IEC-27001|A.9.4.3,ITSG-33|IA-5,LEVEL|2NS,SWIFT-CSCv1|4.1,TBA-FIISB|26.2.1,TBA-FIISB|26.2.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/pwpolicy -getaccountpolicies | /usr/bin/egrep minimumSymbols"
      expect      : "minimumSymbols"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.2.6 Complex passwords must contain uppercase and lowercase letters"
      info        : "Complex passwords contain one character from each of the following classes: English uppercase letters, English lowercase letters, Westernized Arabic numerals, and non-alphanumeric characters.

Ensure that both uppercase and lowercase letters are part of the password policy on the computer

Rationale:

The more complex a password the more resistant it will be against persons seeking unauthorized access to a system."
      solution    : "Perform the following to implement the prescribed state for all pwpolicy controls

1. Run the following command in Terminal:

pwpolicy -setaccountpolicies

Examples in pwpolicy man page"
      reference   : "800-171|3.5.7,800-53|IA-5(1),CIP|007-6-R5,CN-L3|7.1.2.7(e),CN-L3|7.1.3.1(b),CSF|PR.AC-1,HIPAA|164.308(a)(5)(ii)(D),ISO/IEC-27001|A.9.4.3,ITSG-33|IA-5(1),LEVEL|2NS,NESA|T5.2.3,NIAv2|AM19a,NIAv2|AM19b,NIAv2|AM19c,NIAv2|AM19d,NIAv2|AM22a,PCI-DSSv3.1|8.2.3,PCI-DSSv3.2|8.2.3,SWIFT-CSCv1|4.1,TBA-FIISB|26.2.1,TBA-FIISB|26.2.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/pwpolicy -getaccountpolicies | /usr/bin/egrep com\\.apple\\.uppercaseAndLowercase | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
      expect      : "com\\.apple\\.uppercaseAndLowercase"
    </custom_item>

    <report type:"WARNING">
      description : "5.7 Automatically lock the login keychain for inactivity"
      info        : "The login keychain is a secure database store for passwords and certificates and is created for each user account on macOS. The system software itself uses keychains for secure storage. Anyone with physical access to an unlocked keychain where the screen is also unlocked can copy all passwords in that keychain. Application access to the login keychain does not keep it unlocked. If you set Apple Mail to check for email every 10 minutes using the keychain for credentials and the keychain to lock every 15 minutes if inactive it will still cause the keychain to lock. The approach recommended here is that the login keychain be set to periodically lock when inactive to reduce the risk of password exposure or unauthorized use of credentials by a third party. The time period that an organization uses will depend on how great the use is of keychain aware applications. Organizations that use Firefox and Thunderbird will have a much different tolerance than those organization using keychain aware applications extensively.

Rationale:

While logged in, the keychain does not prompt the user for passwords for various systems and/or programs. This can be exploited by unauthorized users to gain access to password protected programs and/or systems in the absence of the user. Timing out the keychain can reduce the exploitation window.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Perform the following to implement the prescribed state:

1. Open Utilities
2. Select Keychain Access
3. Select a keychain
4. Select Edit
5. Select Change Settings for keychain
6. Authenticate, if requested.
7. Change the Lock after # minutes of inactivity setting for the Login Keychain to an approved value that should NOT be longer than 6 hours or 360 minutes or based on the access frequency of the security credentials included in the keychain for other keychains."
      reference   : "800-53|IA-5,CSF|PR.AC-1,LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "5.8 Ensure login keychain is locked when the computer sleeps"
      info        : "The login keychain is a secure database store for passwords and certificates and is created for each user account on macOS. The system software itself uses keychains for secure storage. Anyone with physical access to an unlocked keychain where the screen is also unlocked can copy all passwords in that keychain. The approach recommended here is that the login keychain be set to lock when when the computer sleeps to reduce the risk of password exposure. Organizations that use Firefox and Thunderbird will have a much different tolerance than those organization using keychain aware applications extensively.

Rationale:

While logged in, the keychain does not prompt the user for passwords for various systems and/or programs. This can be exploited by unauthorized users to gain access to password protected programs and/or systems in the absence of the user."
      solution    : "Perform the following to implement the prescribed state:

1. Open Utilities
2. Select Keychain Access
3. Select a keychain
4. Select Edit
5. Select Change Settings for keychain
6. Authenticate, if requested.
7. Select Lock when sleeping setting"
      reference   : "800-53|IA-5(13),CSF|PR.AC-1,LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/security show-keychain-info 2>&1"
      expect      : "Keychain[\\s]*\"\<NULL\>\"[\\s]*lock\-on\-sleep"
    </custom_item>

    <custom_item>
      type        : MACOSX_DEFAULTS_READ
      description : "5.9 Enable OCSP and CRL certificate checking - CRLStyle"
      info        : "Certificates should only be trusted if they have both a satisfactory trust chain and they have not been revoked. macOS can check whether the certificate is still valid based on issued parameters within the certificate.

Rationale:

A rogue or compromised certificate should not be trusted"
      solution    : "Run the following commands to enforce the compliant state

To set the CRL settings:

defaults write com.apple.security.revocation CRLStyle -string RequireIfPresent

To set the OCSP settings:

defaults write com.apple.security.revocation OCSPStyle -string RequireIfPresent"
      reference   : "800-53|IA-5(2),CSF|PR.AC-1,ITSG-33|IA-5(2),LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      regex       : "RequireIfPresent"
      plist_item  : "CRLStyle"
      plist_name  : "com.apple.security.revocation"
      plist_user  : "all"
    </custom_item>

    <custom_item>
      type        : MACOSX_DEFAULTS_READ
      description : "5.9 Enable OCSP and CRL certificate checking - OCSPStyle"
      info        : "Certificates should only be trusted if they have both a satisfactory trust chain and they have not been revoked. macOS can check whether the certificate is still valid based on issued parameters within the certificate.

Rationale:

A rogue or compromised certificate should not be trusted"
      solution    : "Run the following commands to enforce the compliant state

To set the CRL settings:

defaults write com.apple.security.revocation CRLStyle -string RequireIfPresent

To set the OCSP settings:

defaults write com.apple.security.revocation OCSPStyle -string RequireIfPresent"
      reference   : "800-53|IA-5(2),CSF|PR.AC-1,ITSG-33|IA-5(2),LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      regex       : "RequireIfPresent"
      plist_item  : "OCSPStyle"
      plist_name  : "com.apple.security.revocation"
      plist_user  : "all"
    </custom_item>

    <if>
      <condition type:"AND">
        <custom_item>
          type        : CMD_EXEC
          description : "5.14 Ensure system is set to hibernate"
          cmd         : "/usr/sbin/system_profiler SPHardwareDataType | /usr/bin/egrep MacBook"
          expect      : "MacBook"
        </custom_item>
      </condition>

      <then>
        <custom_item>
          type        : CMD_EXEC
          description : "5.14 Ensure system is set to hibernate"
          info        : "In order to use a computer with Full Disk Encryption (FDE) macOS must keep encryption keys in memory to allow the use of the disk that has been FileVault protected. The storage volume has been unlocked and acts as if it was not encrypted. When the system is not in use the volume is protected through encryption. When the system is sleeping and available to quickly resume the encryption keys remain in memory.

If an unauthorized party has possession of the computer and the computer is only slept there are known attack vectors that can be attempted against the RAM that has the encryption keys or the running operating system that is protected by a login screen. Network attacks if network interfaces are on as well as USB or other open device ports are possible. Most of these attacks require knowledge of unpatched vulnerabilities or a high level of sophistication if all the other controls function as intended.

There is little impact on hibernating the system rather than sleeping after an appropriate time period to remediate the risk of OS level attacks. Hibernation writes the keys to desk and requires FileVault to be unlocked prior to the OS being available. In the case of unauthorized personnel with access to the computer encryption would have to be broken prior to attacking the operating system in order to recover data from the system.

[https://www.helpnetsecurity.com/2018/08/20/laptop-sleep-security/](https://www.helpnetsecurity.com/2018/08/20/laptop-sleep-security/)

Mac systems should be set to hibernate after sleeping for a risk acceptable time period. The default value for 'standbydelay' is three hours (10800 seconds). This value is likely appropriate for most Desktops. If Mac desktops are deployed in unmonitored less physically secure areas with confidential data this value might be adjusted. The desktop or would have to retain power so that the running OS or physical RAM could be attacked however.

MacBooks should be set so that the standbydelay is 15 minutes (900 seconds) or less. This setting should allow laptop users in most cases to stay within physically secured areas while going to a conference room, auditorium or other internal location without having to unlock the encryption. When the user goes home at night the laptop will auto-hibernate after 15 minutes and require the FileVault password to unlock prior to logging back in to system when it resumes.

Rationale:

To mitigate the risk of data loss the system should power down and lock the encrypted drive after a specified time. Laptops should hibernate 15 minutes or less after sleeping."
          solution    : "Perform the following to configure laptops as prescribed:

1. Run the following command in Terminal:

sudo pmset -a standbydelay 900"
          reference   : "800-171|3.4.2,800-53|CM-6,CN-L3|8.1.10.6(d),CSF|PR.IP-1,ITSG-33|CM-6,LEVEL|2S,NESA|T3.2.1,SWIFT-CSCv1|2.3"
          see_also    : "https://workbench.cisecurity.org/files/2105"
          cmd         : "/usr/bin/pmset -g | /usr/bin/egrep standbydelay"
          expect      : "standbydelay[\\s]+([1-9]|[1-9][0-9]|[1-8][0-9][0-9]|900)$"
        </custom_item>
      </then>

      <else>
        <custom_item>
          type        : CMD_EXEC
          description : "5.14 Ensure system is set to hibernate"
          info        : "In order to use a computer with Full Disk Encryption (FDE) macOS must keep encryption keys in memory to allow the use of the disk that has been FileVault protected. The storage volume has been unlocked and acts as if it was not encrypted. When the system is not in use the volume is protected through encryption. When the system is sleeping and available to quickly resume the encryption keys remain in memory.

If an unauthorized party has possession of the computer and the computer is only slept there are known attack vectors that can be attempted against the RAM that has the encryption keys or the running operating system that is protected by a login screen. Network attacks if network interfaces are on as well as USB or other open device ports are possible. Most of these attacks require knowledge of unpatched vulnerabilities or a high level of sophistication if all the other controls function as intended.

There is little impact on hibernating the system rather than sleeping after an appropriate time period to remediate the risk of OS level attacks. Hibernation writes the keys to desk and requires FileVault to be unlocked prior to the OS being available. In the case of unauthorized personnel with access to the computer encryption would have to be broken prior to attacking the operating system in order to recover data from the system.

[https://www.helpnetsecurity.com/2018/08/20/laptop-sleep-security/](https://www.helpnetsecurity.com/2018/08/20/laptop-sleep-security/)

Mac systems should be set to hibernate after sleeping for a risk acceptable time period. The default value for 'standbydelay' is three hours (10800 seconds). This value is likely appropriate for most Desktops. If Mac desktops are deployed in unmonitored less physically secure areas with confidential data this value might be adjusted. The desktop or would have to retain power so that the running OS or physical RAM could be attacked however.

MacBooks should be set so that the standbydelay is 15 minutes (900 seconds) or less. This setting should allow laptop users in most cases to stay within physically secured areas while going to a conference room, auditorium or other internal location without having to unlock the encryption. When the user goes home at night the laptop will auto-hibernate after 15 minutes and require the FileVault password to unlock prior to logging back in to system when it resumes.

Rationale:

To mitigate the risk of data loss the system should power down and lock the encrypted drive after a specified time. Laptops should hibernate 15 minutes or less after sleeping."
          solution    : "Perform the following to configure laptops as prescribed:

1. Run the following command in Terminal:

sudo pmset -a standbydelay 900"
          reference   : "800-171|3.4.1,800-53|CM-8,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|PR.DS-3,ITSG-33|CM-8,LEVEL|2S,NESA|T1.2.1,NESA|T1.2.2"
          see_also    : "https://workbench.cisecurity.org/files/2105"
          cmd         : "/usr/sbin/system_profiler SPHardwareDataType | /usr/bin/egrep MacBook | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
          expect      : "none"
        </custom_item>
      </else>
    </if>

    <custom_item>
      type        : BANNER_CHECK
      description : "5.18 Create a Login window banner"
      info        : "A Login window banner warning informs the user that the system is reserved for authorized use only. It enforces an acknowledgment by the user that they have been informed of the use policy in the banner if required

Rationale:

An access warning may reduce a casual attacker's tendency to target the system. Access warnings may also aid in the prosecution of an attacker by evincing the attacker's knowledge of the system's private status, acceptable use policy, and authorization requirements."
      solution    : "Place a file named PolicyBanner.txt in/Library/Security/"
      reference   : "800-171|3.1.9,800-53|AC-8,ITSG-33|AC-8,LEVEL|2S,NESA|M1.3.6,NIAv2|AM10a,NIAv2|AM10b,NIAv2|AM10c,NIAv2|AM10d,NIAv2|AM10e,TBA-FIISB|45.2.4"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      file        : "/Library/Security/PolicyBanner.txt"
# Note: Variable @BANNER_TEXT@ replaced with "All activities performed on this system will be monitored." in field "content".
      content     : "All activities performed on this system will be monitored."
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "5.20 Disable Fast User Switching"
      info         : "Fast user switching allows a person to quickly log in to the computer with a different account. While only a minimal security risk, when a second user is logged in, that user might be able to see what processes the first user is using, or possibly gain other information about the first user. In a large directory environment where it is difficult to limit login access many valid users can login to other user's assigned computers.

Rationale:

Fast user switching allows multiple users to run applications simultaneously at console. There can be information disclosed about processes running under a different user. Without a specific configuration to save data and log out users can have unsaved data running in a background session that is not obvious."
      solution     : "In System Preferences: Accounts, Login Options, make sure the 'Enable fast user switching' checkbox is off."
      reference    : "800-53|AC-10,ITSG-33|AC-10,LEVEL|2NS,NESA|T5.5.1"
      see_also     : "https://workbench.cisecurity.org/files/2105"
      regex        : "0"
      plist_item   : "MultipleSessionEnabled"
      plist_name   : "/Library/Preferences/.GlobalPreferences"
      plist_option : CANNOT_BE_NULL
    </custom_item>

    <report type:"WARNING">
      description : "5.21 Secure individual keychains and items"
      info        : "By default, the keychain for an account, especially a local account, have the same password as the account's logon password. It is possible to change the passwords on keychains to something different than the login password, and doing so would keep that keychain locked until needed after login. This is especially important when a smartcard is being used for console login. Keychains need to be protected by more than a pin in order to be secured and the default behavior with a smartcard will result in a pin for the login password. Individual keychain entries can have special ACLs to increase security as well.

Rationale:

Each keychain entry can have different access controls. It's possible to set the keychain item to require a keychain password every time an item is accessed, even if the keychain is unlocked. This level of security could be useful for bank passwords or other passwords that need extra security.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1. Open 'Utilities'
2. Select 'Keychain Access'
3. Double-click keychain
4. Select 'Access' 'Control'
5. Check box next to 'Ask for Keychain Password'"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "5.22 Create specialized keychains for different purposes"
      info        : "The keychain is a secure database store for passwords and certificates and is created for each user account on macOS. The system software itself uses keychains for secure storage. Users can create more than one keychain to protect various passwords separately.

Rationale:

If the user can logically split password and other entries into different keychains with different passwords, a compromise of one password will have limited effect.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1. Open 'Utilities'
2. Select 'Keychain Access'
3. Select 'File'
4. Select 'New Keychain'
5. Input name of new keychain next to 'Save As'
6. Select 'Create'
7. Drag and drop desired keychain items into new keychain from login keychain"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "6.4 Safari disable Internet Plugins for global use"
      info        : "Starting with Safari 10 and continuing with 11 Apple changed the model on how the built-in web browser handles Internet Plug-Ins. Instead of using a global approach where the Plug-in is either on or off for all sites the default decision is about allowing, not allowing, or allowing permanently for a specific site that is visited. Other browsers are moving to stop using Plug-ins altogether and insist on the use of HTML 5 for rich content. Only allowing Plug-in content from specific sites is a viable security option. In the Security Preferences, Plug-in settings it is possible to override the security feature and enable Plug-in content globally by Plug-in. With the controls planned in other macOS browsers allowing content globally is likely to put Safari users more at risk than other browser users.

There are three options for Internet Plug-ins with Safari 10 'When visiting other websites' Ask, Off or On. The on setting should not be used.

[https://support.apple.com/en-us/HT202819](https://support.apple.com/en-us/HT202819)

Rationale:

Allow Internet Plugins only on required sites"
      solution    : "Select either ask to use or block"
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2NS,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/files/2105"
      cmd         : "/usr/bin/defaults read ~/Library/Preferences/com.apple.Safari.plist | /usr/bin/grep -i 'PlugInFirstVisitPolicy = *'"
      expect      : ".*= (PlugInPolicyAsk|PlugInPolicyBlock);"
    </custom_item>

    <report type:"WARNING">
      description : "6.5 Use parental controls for systems that are not centrally managed"
      info        : "Many aspects and features of macOS can be restricted on a user-by-user basis via the Parental Controls feature. This includes computer usage time limits, application accessibility limitations, and website restrictions. Although this feature is called Parental Controls, these restrictions may be appropriate for corporate, government, or educational use.

Rationale:

Limiting usage and restricting features for managed users reduces the risk of the user and/or system being exposed to malicious and/or inappropriate content.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1. Open 'System Preferences'
2. Select 'Users & Groups'
3. Highlight managed user
4. Check box next to 'Enable parental controls'
5. Select 'Open Parental Controls'
6. Select items within the 'Parental Controls' feature that should be restricted."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.1 Wireless technology on OS X"
      info        : "Some organizations have comprehensive rules that cover the use of wireless technologies in order to implement operational security. There are specific policies governing the use of both Bluetooth and Wi-Fi (802.11) that often include disabling the wireless capability in either software or hardware or both.

Wireless access is part of the feature set required for mobile computers and is considered essential for most users. The general use case for macOS is to use wireless connectivity, Apple provides a wireless network card and Bluetooth capability in almost every product they make. Bluetooth keyboards are now the default selection where a keyboard is not already integrated into the device.

There are instructions on how to remove parts of the operating system in order to remediate wireless connectivity but they are not recommended within the scope of this Benchmark.

https://apple.stackexchange.com/questions/99686/how-to-easily-and-completely-disable-enable-wlan-so-it-cannot-be-turned-on-agai

https://apple.stackexchange.com/questions/123326/disable-bluetooth-permanently

macOS computers will not allow this if System Integrity Protection is enabled.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.2 iSight Camera Privacy and Confidentiality Concerns"
      info        : "If the computer is present in an area where there are privacy concerns or sensitive images or actions are taking place the camera should be covered at those times. A permanent cover or alteration may be required when the computer is always located in a confidential area.

Malware is continuously discovered that circumvents the privacy controls of the built-in camera. No computer has perfect security and it seems likely that even if all the drivers are disabled or removed that working drivers can be re-introduced by a determined attacker.

At this point video chatting and other uses of the built-in camera are standard uses for a computer. It is contrary to a standard use case to permanently remove the camera. In cases where the camera is not allowed to be used at all or when the computer is located in private areas additional precautions are warranted. The General rule should be that if the camera can capture images that could cause embarrassment or an adverse impact the camera should be covered until it is appropriate to use.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.3 Computer Name Considerations"
      info        : "If the computer is used in an organization that assigns host names, it is a good idea to change the computer name to the host name. This is more of a best practice than a security measure. If the host name and the computer name are the same, computer support may be able to track problems down more easily.

With mobile devices using DHCP IP tracking has serious drawbacks, hostname or computer name tracking makes much more sense for those organizations that can implement it. If the computer is using different names for the 'Computer Name' DNS and Directory environments it can be difficult to manage Macs in an Enterprise asset inventory.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.4 Software Inventory Considerations"
      info        : "With the introduction of Mac OS X 10.6.6, Apple added a new application, App Store, which resides in the Applications directory. This application allows a user with admin privileges and an Apple ID to browse Apple's online App Store, purchase (including no cost purchases), and install new applications, bypassing Enterprise software inventory controls. Any admin user can install software in the /Applications directory whether from internet downloads, thumb drives, optical media, cloud storage or even binaries through email. Even standard users can run executables if permitted. The source of the software is not nearly as important as a consistent audit of all installed software for patch compliance and appropriateness.

A single user desktop where the user, administrator and the person approving software are all the same person probably does not need to audit software inventory to this extent. It is helpful in the case of stability problems or malware however.

Scan systems on a monthly basis and determine the number of unauthorized pieces of software that are installed. Verify that if an unauthorized piece of software is found one month, it is removed from the system the next.

Export Apple System Profiler information through the built-in or other third party tools on an organizationally defined timetable.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.5 Firewall Consideration"
      info        : "In addition to the Application Layer Firewall ('alf') mentioned in the benchmark, macOS also ships with packet filter, or 'pf'. Leveraging 'pf' is beyond the scope of this Benchmark. For more information, please see:

- https://support.apple.com/kb/ht5519
- http://blog.scottlowe.org/2013/05/15/using-pf-on-os-x-mountain-lion/

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.7 App Store Automatically download apps purchased on other Macs Considerations"
      info        : "With 10.9 Apple expanded the capability of the App Store to automatically download macOS applications that were purchased in the App Store on another Mac. This feature can be very desirable for personal Macs or in a small business setting so that all purchased software through Apple's App Store is provisioned on all macOS Computers, just like iOS. This feature may not be desirable in Enterprise environments where the expectations of handling software licenses, tracking software inventory and personal software are different.

Please evaluate your organizations expectations about the use of personal software and software license tracking to align with this setting.

For those organizations that are using Enterprise Apple IDs for their employees the reverse is true. If the user has the username and password for their Apple ID and software is being purchased on that account the user could download the software on other computers they have access to.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.8 Extensible Firmware Interface (EFI) password"
      info        : "EFI is the software link between the motherboard hardware and the software operating system. EFI determines which partition or disk to load macOS from, it also determines whether the user can enter single-user mode. The main reasons to set a firmware password have been protections against an alternative boot disk, protection against a passwordless root shell through single user mode and protection against firewire DMA attacks. In the past it was not difficult to reset the firmware password by removing RAM but it did make tampering slightly harder and having to remove RAM remediated memory scraping attacks through DMA. It has always been difficult to Manage the firmware password on macOS computers, though some tools did make it much easier.

Apple patched OS X in 10.7 to mitigate the DMA attacks and the use of FileVault 2 Full-Disk Encryption mitigates the risk of damage to the boot volume if an unauthorized user uses a different boot volume or uses Single User Mode. Apple's reliance on the recovery partition and the additional features it provides make controls that do not allow the user to boot into the recovery partition less attractive.

Starting in Late 2010 with the MacBook Air Apple has slowly updated the requirements to recover from a lost firmware password. Apple only supports taking the computer to an Apple authorized service provider. This change makes managing the firmware password effectively more critical if it is used.

Setting the firmware password may be good practice in some environments. We cannot recommend it as a standard security practice at this time.

http://support.apple.com/kb/ts3554

https://jamfnation.jamfsoftware.com/article.html?id=58

http://derflounder.wordpress.com/2012/02/05/protecting-yourself-against-firewire-dma-attacks-on-10-7-x/

http://derflounder.wordpress.com/2013/04/26/booting-into-single-user-mode-on-a-filevault-2-encrypted-mac/

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.9 Apple ID password reset"
      info        : "Apple has provided services for several years that allowed a user to reset a local account password on a computer using their Apple ID and a service to store the FileVault Master Password with Apple that would be controlled by access to an Apple ID. These distinct services have been more cleanly integrated starting in 10.12.

This integrated service for password and decryption is a concern in Enterprise environments. Normal Enterprise management controls mitigate the risk of external control of organizational systems. The user of the system already has the ability to unlock the disk in order to login and use it and some form of password recovery function is likely already in place for any approved accounts. In addition:

- You cannot reset anything but a local account
- You need physical access to the computer on a network that can phone home to Apple
- Enterprise FileVault management precludes the use of Apple's personal encryption recovery tied to a User's Apple ID
- The current login keychain will have to be discarded unless the user remembers the old password

This service allows for organizational computer users to utilize AppleIDs for encryption key escrow and user account management. The use of Apple's services rather than Enterprise services may be considered inappropriate.

[https://support.apple.com/en-us/HT204837](https://support.apple.com/en-us/HT204837)

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.11 App Store Password Settings"
      info        : "With OS X 10.11 Apple added settings for password storage for the App Store in macOS. These settings parallel the settings in iOS. As with iOS the choices are a requirement to provide a password after every purchase or to have a 15 minute grace period, and whether to require a password for free purchases. The response to this setting is stored in a cookie and processed by iCloud.

There is plenty of risk information on the wisdom of this setting for parents with children buying games on iPhones and iPads. the most relevant information here is the likelihood that users that are not authorized to download software may have physical access to an unlocked computer where someone who is authorized recently made a purchase. If that is a concern a password should be required at all times for App Store access in the Password Settings controls

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>

    <report type:"WARNING">
      description : "7.14 System information backup to remote computers"
      info        : "It is best practice to ensure that local computers are not a single point of failure for logging and auditing records about activity on the computer itself. Whether end user activity or system process information a mechanism should be in place to transfer the logs to another system that is hardened to receive them. A hardened log host reduces the risk of failure or compromise, particularly with user end points. From an enterprise management standpoint those records should be reviewed to ensure that there is not a common exploitable vulnerability, system bug or even hardware issue that can effect other devices in the environment.

With changes in Apple's logging methods in the last few years third party tools appear to be preferred to ensure logs and records are obtained appropriately. Aggressive retention likely requires more space than available on built-in SSDs even if offline Time Machine backups are large and pristine.

Please ensure that solutions to capture and retain log and audit records are in place.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/2105"
    </report>
  </then>

  <else>
    <report type:"WARNING">
      description : "CIS_Apple_macOS_10.13_v1.0.0_Level_2.audit from CIS Apple macOS 10.13 Benchmark v1.0.0"
      info        : "NOTE: Nessus has not identified that the chosen audit applies to the target device."
    </report>
  </else>
</if>

</check_type>
