#
# This script is Copyright (C) 2004-2020 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
#
# $Revision: 1.8 $
# $Date: 2020/07/14 $
#
# description	: This .audit file is written against the Center for Internet
# 	  Security benchmark for Apple OSX 10.11 El Capitan, version 1.1.0 .
# 	  https://workbench.cisecurity.org/files/301
#
# NOTE		: Some queries in this .audit require site-specific data to be known to the query in order to function properly.
# 	  Please note the following queries and edit their values accordingly.
#
# 	  5.13 Create a Login window banner
#
#<ui_metadata>
#<display_name>CIS Apple OSX 10.11 El Capitan L2 v1.1.0</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Apple OSX 10.11 El Capitan L2</name>
#  <version>1.1.0</version>
#  <link>https://workbench.cisecurity.org/files/301</link>
#</spec>
#<labels>unix,cis,macosx,macosx_10,macosx_10.11,agent</labels>
#<benchmark_refs>LEVEL,CSCv6</benchmark_refs>
#<variables>
#  <variable>
#    <name>BANNER_TEXT</name>
#    <default>All activities performed on this system will be monitored.</default>
#    <description>Banner Text</description>
#    <info>This is the text for the warning a user receives when logging onto the system.</info>
#  </variable>
#</variables>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : CMD_EXEC
      description : "Mac OSX 10.11 El Capitan is installed"
      cmd         : "/usr/bin/sw_vers | /usr/bin/grep 'ProductVersion'"
      expect      : "^ProductVersion[\\s]*:[\\s]*10\.11"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "Apple OSX 10.11 El Capitan Level 2, version 1.1.0"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "2.2.1 Enable 'Set time and date automatically'"
      info        : "Kerberos may not operate correctly if the time on the Mac is off by more than 5 minutes. This in turn can affect Apple's single sign-on feature, Active Directory logons, and other features."
      solution    : "Perform the following to implement the prescribed state:
1. Open System Preferences
2. Select Date & Time
3. Select Set date and time automatically
Alternatively run the following command:
sudo systemsetup -setnetworktimeserver <timeserver>
sudo systemsetup -setnetworktimeserver on"
      reference   : "800-171|3.3.7,800-53|AU-8(1),CSCv6|6.1,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.4,ITSG-33|AU-8(1),LEVEL|2NS,NESA|T3.6.7,NIAv2|NS44,NIAv2|NS45,NIAv2|NS46,NIAv2|NS47,PCI-DSSv3.1|10.4,PCI-DSSv3.2|10.4"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/sbin/systemsetup -getusingnetworktime"
      expect      : "Network Time:[\\s]*On"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - top right corner"
      info         : "Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:
Open System Preferences
Select Mission Control
Select Hot Corners
Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/301"
      not_regex    : ".* = 6"
      plist_item   : "wvous-tr-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - top left corner"
      info         : "Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:
Open System Preferences
Select Mission Control
Select Hot Corners
Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/301"
      not_regex    : ".* = 6"
      plist_item   : "wvous-tl-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - bottom left corner"
      info         : "Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:
Open System Preferences
Select Mission Control
Select Hot Corners
Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/301"
      not_regex    : ".* = 6"
      plist_item   : "wvous-bl-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.3.2 Secure screen saver corners - bottom right corner"
      info         : "Setting a hot corner to disable the screen saver poses a potential security risk since an unauthorized person could use this to bypass the login screen and gain access to the system."
      solution     : "Perform the following to implement the prescribed state:
Open System Preferences
Select Mission Control
Select Hot Corners
Remove any corners which are set to Disable Screen Saver"
      reference    : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NESA|T2.3.8,NESA|T2.3.9,NIAv2|AM23a,NIAv2|AM23b"
      see_also     : "https://workbench.cisecurity.org/files/301"
      not_regex    : ".* = 6"
      plist_item   : "wvous-br-corner"
      plist_name   : "com.apple.dock"
      plist_option : CAN_BE_NULL
      plist_user   : "all"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.5.1 Disable 'Wake for network access'"
      info        : "Disabling this feature mitigates the risk of an attacker remotely waking the system and gaining access."
      solution    : "Perform the following to implement the prescribed state:
Run the following command in Terminal:
sudo pmset -a womp 0
Verify the value returned is 0
Note: The -c flag means 'wall power.' Different settings must be used for other power sources."
      reference   : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),CSCv6|3.1,CSF|PR.IP-1,ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NIAv2|AM23c,NIAv2|AM23d,PCI-DSSv3.1|2.2.4,PCI-DSSv3.2|2.2.4"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/pmset -g | /usr/bin/grep womp"
      expect      : "^[\\s]*womp[\\s]*0$"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.5.2 Disable sleeping the computer when connected to power"
      info        : "The ability to apply security patches and perform vulnerability assessments on the system is reduced when the system is sleeping."
      solution    : "In System Preferences: Energy Saver, drag the slider for 'Put the computer to sleep...' to never.
Alternatively, use the following command:
sudo /usr/bin/pmset -c sleep 0"
      reference   : "800-171|3.1.10,800-53|AC-11,CN-L3|8.1.4.1(b),CSCv6|16.5,ISO/IEC-27001|A.11.2.8,ITSG-33|AC-11,LEVEL|2S,NIAv2|AM23c,NIAv2|AM23d"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/pmset -g | /usr/bin/grep sleep"
      expect      : "^[\\s]*sleep[\\s]*0$"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.6.6 Enable Location Services"
      info        : "Location services are helpful in most use cases and can simplify log and time management
where computers change time zones."
      solution    : "Perform the following to ensure the system is configured as prescribed-
1. In Terminal, run the following command-sudo launchctl load /System/Library/LaunchDaemons/com.apple.locationd.plist2. There should be no responseIn some use cases organizations may not want Location Services running in those cases
'unload' rather than 'load' is the appropriate commandPerform the following to ensure the system is configured as prescribed-1. In Terminal, run the following command-sudo launchctl unload /System/Library/LaunchDaemons/com.apple.locationd.plist2. Verify that the results include- Could not find specified service"
      reference   : "800-53|CM-8(8),CSF|DE.CM-7,CSF|PR.DS-3,LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/bin/launchctl load /System/Library/LaunchDaemons/com\.apple\.locationd\.plist"
      expect      : ".*service[\\s]+already[\\s]+loaded"
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.6.7 Monitor Location Services Access"
      info         : "Privacy controls should be monitored for appropriate settings"
      solution     : "Safari ConfigurationPerform the following to implement the prescribed state-1. Open Safari
2. Select Safari from the menu bar
3. Select Preferences
4. Select Privacy
5. Check Deny without prompting or Prompt for each website once each dayPerform the following to review applications in System Preferences-1. Open System Preferences
2. Select Security & Privacy
3. Select Privacy
4. Select location Services
5. Uncheck applications that are not approved for access to location service
information"
      reference    : "800-53|CM-8(8),CSF|DE.CM-7,CSF|PR.DS-3,LEVEL|2NS"
      see_also     : "https://workbench.cisecurity.org/files/301"
      regex        : "0|1"
      plist_item   : "SafariGeolocationPermissionPolicy globalstate"
      plist_name   : "/Library/Preferences/com.apple.safari.plist"
      plist_option : CAN_BE_NULL
    </custom_item>

    <report type:"WARNING">
      description : "2.7.1 iCloud configuration"
      info        : "Apple's iCloud is a consumer oriented service that allows a user to store data as well as find, control and backup devices that are associated with their Apple ID (Apple account.) The use of iCloud on Enterprise devices should align with the acceptable use policy for devices that are managed as well as confidentiality requirements for data handled by the user. If iCloud is allowed the data that is copied to Apple servers will likely be duplicated on both personal as well as Enterprise devices.

For many users the Enterprise email system may replace many of the available features in iCloud. If using either an Exchange or Google environment email, calendars, notes and contacts can sync to the official Enterprise repository and be available through multiple devices.

Depending on workplace requirements it may not be appropriate to intermingle Enterprise and personal bookmarks, photos and documents. Since the service allows every device associated with the users ID to synchronize and have access to the cloud storage the concern is not just about having sensitive data on Apple's servers but having that same data on the phone of the teenage son or daughter of an employee.

The remote connectivity of 'Back to My Mac' relies on screen sharing that should already be turned off, if available the users Apple ID (personal?) can be used for remote access to the Enterprise computer rather than through Enterprise managed accounts.

      NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Apple's iCloud is just one of many cloud based solutions being used for data synchronization across multiple platforms and it should be controlled consistently with other cloud services in your environment. Work with your employees and configure the access to best enable data protection for you mission."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "2.7.2 iCloud keychain"
      info        : "The iCloud keychain is Apple's password manager that works with OS X and iOS. The capability allows users to store passwords in either iOS or OS X for use in Safari on both platforms and other iOS integrated applications.  The most pervasive use is driven by iOS use rather than OS X. The passwords stored in an OS X keychain on an Enterprise managed computer could be stored in Apple's cloud and then be available on a personal computer using the same account. The stored passwords could be for organizational as well as personal accounts.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Open System Preferences: iCloud and deselect Keychain if it is not approved in your organization"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "2.7.3 iCloud Drive"
      info        : "iCloud Drive is Apple's storage solution for applications on both OS X and iOS to use the same files that are resident in Apple's cloud storage. The iCloud Drive folder is available much like Dropbox or the Microsoft or Google solutions.

One of the concerns in public cloud storage is that proprietary data may be inappropriately stored in an end user's personal repository. Organizations that need specific controls on information should ensure that this service is turned off or the user knows what information must be stored on services that are approved for storage

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "If cloud storage is not allowed in your organization in System Preferences: iCloud uncheck iCloud Drive"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "2.8.1 Time Machine Auto-Backup"
      info         : "Backups should automatically run whenever the backup drive is avaialable"
      solution     : "Perform the following to configure the system as prescribed-
1. Run the following command in Terminal-defaults write /Library/Preferences/com.apple.TimeMachine.plist AutoBackup 1Impact-The backup will run periodically in the background and could have user impact while
running."
      reference    : "800-171|3.8.9,800-53|CP-9,CSF|PR.IP-4,ISO/IEC-27001|A.12.3.1,ITSG-33|CP-9,LEVEL|2NS,NESA|M5.2.3,NESA|T2.2.4,NESA|T3.5.1"
      see_also     : "https://workbench.cisecurity.org/files/301"
      regex        : "[^0]+"
      plist_item   : "AutoBackup"
      plist_name   : "/Library/Preferences/com.apple.TimeMachine.plist"
      plist_option : CANNOT_BE_NULL
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "2.11 Java 6 is not the default Java runtime"
      info        : "Java is one of the most exploited environments and is no longer maintained by Apple, old versions may still be installed and should be removed from the computer or not be in the default path."
      solution    : "Java 6 can be removed completely or, if necessary Java applications will only work with Java 6, a custom path can be used."
      reference   : "800-171|3.4.1,800-53|CM-8,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|PR.DS-3,ISO/IEC-27001|A.8.1.1,ITSG-33|CM-8,LEVEL|2S,NESA|T1.2.1,NESA|T1.2.2,NIAv2|NS35"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/java -version 2>&1 | /usr/bin/egrep -o '1\.[456]\.[^\"\) ]+' | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
      expect      : "none"
    </custom_item>

    <report type:"WARNING">
      description : "2.12 Securely delete files as needed"
      info        : "Securely removing files mitigates the risk of an admin user on the system recovering sensitive files that the user has deleted. It is possible for anyone with physical access to the device to get access if FileVault is not used, or to recover deleted data if the FileVault volume is already mounted.

      NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Securely deleting files can take a long time, with FileVault in place the protection is erasing data within an already encrypted volume. This control does not effect the use of the rm command in the terminal. Users who rarely have large files to erase can use srm
-	cd ~/.Trash
- srm myproject-cui.pptx"
      reference   : "800-53|CM-6,CSF|PR.IP-1,LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.3 Configure Security Auditing Flags - 'audit successful/failed login/logout events'"
      info        : "Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, has begun, or is about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:
Open a terminal session and edit the /etc/security/audit_control file
Find the line beginning with 'flags'
Add the following flags: lo,ad,fd,fm,-all.
Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*lo).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.3 Configure Security Auditing Flags - 'audit successful/failed administrative events'"
      info        : "Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, has begun, or is about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:
Open a terminal session and edit the /etc/security/audit_control file
Find the line beginning with 'flags'
Add the following flags: lo,ad,fd,fm,-all.
Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*ad).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.3 Configure Security Auditing Flags - 'audit successful/failed file deletion events'"
      info        : "Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, has begun, or is about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:
Open a terminal session and edit the /etc/security/audit_control file
Find the line beginning with 'flags'
Add the following flags: lo,ad,fd,fm,-all.
Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*fd).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.3 Configure Security Auditing Flags - 'audit successful/failed file attribute modification events'"
      info        : "Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, has begun, or is about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:
Open a terminal session and edit the /etc/security/audit_control file
Find the line beginning with 'flags'
Add the following flags: lo,ad,fd,fm,-all.
Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*fm).*$"
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "3.3 Configure Security Auditing Flags - 'audit all failed events across all audit classes'"
      info        : "Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises or attacks that have occurred, has begun, or is about to begin. Audit logs are necessary to provide a trail of evidence in case the system or network is compromised."
      solution    : "Perform the following to implement the prescribed state:
Open a terminal session and edit the /etc/security/audit_control file
Find the line beginning with 'flags'
Add the following flags: lo,ad,fd,fm,-all.
Save the file."
      reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-12,CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|7.1.3.3(c),CN-L3|8.1.3.5(a),CN-L3|8.1.3.5(b),CN-L3|8.1.4.3(a),CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,ISO/IEC-27001|A.12.4.1,ITSG-33|AU-12,LEVEL|2S,NESA|T3.6.2,NESA|T3.6.5,NESA|T3.6.6,NIAv2|SM8,SWIFT-CSCv1|6.4,TBA-FIISB|45.1.1"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/etc/security/audit_control"
      regex       : "^flags:"
      expect      : "^flags:.*(?=.*-all).*$"
    </custom_item>

    <report type:"WARNING">
      description : "3.4 Enable remote logging for Desktops on trusted networks"
      info        : "In addition to local logging, remote logging can be enabled for internal computers on trusted networks. Local logs can be altered if the computer is compromised. Remote logging mitigates the risk of having the logs altered.
NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Perform the following to implement the prescribed state:
1.	Run the following command in Terminal:
sudo pico /etc/syslog.conf
2.	Add the following line to the top of the file, replacing 'your.log.server' with the name or IP address of the log server, and keeping all other lines intact.
*.* @your.log.server
3.	Exit, saving changes.
4.	Reboot the system."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "4.1 Disable Bonjour advertising service"
      info         : "Bonjour can simplify device discovery from an internal rogue or compromised host. An attacker could use Bonjour's multicast DNS feature to discover a vulnerable or poorly-configured service or additional information to aid a targeted attack. Implementing this control disables the continuous broadcasting of 'I'm here!' messages. Typical end-user endpoints should not have to advertise services to other computers. This setting does not stop the computer from sending out service discovery messages when looking for services on an internal subnet, if the computer is looking for a printer or server and using service discovery. To block all Bonjour traffic except to approved devices the pf or other firewall would be needed."
      solution     : "Perform the following to implement the prescribed state -
1. Run the following command in Terminal-
2. defaults write /Library/Preferences/com.apple.mDNSResponder.plist
NoMulticastAdvertisementsImpact-Some applications, like Final Cut Studio and AirPort Base Station management, may not
operate properly if the mDNSResponder is turned off."
      reference    : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSCv6|9.2,CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2S,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,SWIFT-CSCv1|2.3"
      see_also     : "https://workbench.cisecurity.org/files/301"
      regex        : "1"
      plist_item   : "NoMulticastAdvertisements"
      plist_name   : "/Library/Preferences/com.apple.mDNSResponder.plist"
      plist_option : CAN_BE_NULL
    </custom_item>

    <report type:"WARNING">
      description : "4.3 Create network specific locations"
      info        : "Network locations allow the computer to have specific configurations ready for network access when required. Locations can be used to manage which network interfaces are available for specialized network access.

Open System Preferences: Network
Verify each network location is set up properly.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Create multiple network locations as needed.
Delete the Automatic location for any device that does not use multiple network services set for DHCP or dynamic addressing. If network services like FireWire, VPN, AirPort or Ethernet are not used by a specific device class those services should be deleted:
1.	Select Edit Locations from the Locations popup menu.
2.	Select the Automatic location.
3.	Click the minus button for any unneeded service.

Unneeded network interfaces increases the attack surface and could lead to a successful exploit."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "5.1.4 Check Library folder for world writable files"
      info        : "Folders in /Library should not be world writable. The audit check excludes the /Library/Caches folder where the sticky bit is set."
      solution    : "Change permissions so that 'Others' can only execute. (Example Below)
sudo chmod -R o-w /Bad/Directory"
      reference   : "800-171|3.1.5,800-53|AC-6,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.10.6(a),CN-L3|8.1.4.2(d),CSF|PR.AC-4,CSF|PR.DS-5,ITSG-33|AC-6,LEVEL|2S,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,PCI-DSSv3.1|7.1.2,PCI-DSSv3.2|7.1.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/find /Library -type d -perm -2 -ls | /usr/bin/awk '{print} END {if (NR == 0) print \"none\"}'"
      expect      : "none"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.4 Automatically lock the login keychain for inactivity"
      info        : "While logged in, the keychain does not prompt the user for passwords for various systems and/or programs. This can be exploited by unauthorized users to gain access to password protected programs and/or systems in the absence of the user. Timing out the keychain can reduce the exploitation window."
      solution    : "Perform the following to implement the prescribed state:
Open Utilities
Select Keychain Access
Select a keychain
Select Edit
Select Change Settings for keychain <keychain_name>
Authenticate, if requested.
Change the Lock after # minutes of inactivity setting for the Login Keychain to an approved value that should be longer than 6 hours or 3600 minutes or based on the access frequency of the security credentials included in the keychain for other keychains."
      reference   : "800-53|IA-5(13),CSF|PR.AC-1,LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/security show-keychain-info 2>&1"
      expect      : "Keychain[\\s]*\"\<NULL\>\".*timeout=(21[6-9][0-9][0-9]|[3-9][0-9]\\d{3,}|[1-9][0-9]\\d{4,})s"
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "5.5 Ensure login keychain is locked when the computer sleeps"
      info        : "While logged in, the keychain does not prompt the user for passwords for various systems and/or programs. This can be exploited by unauthorized users to gain access to password protected programs and/or systems in the absence of the user."
      solution    : "Perform the following to implement the prescribed state:
Open Utilities
Select Keychain Access
Select a keychain
Select Edit
Select Change Settings for keychain <keychain_name>
Authenticate, if requested.
Select Lock when sleeping setting"
      reference   : "800-53|IA-5(13),CSF|PR.AC-1,LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/security show-keychain-info 2>&1"
      expect      : "Keychain[\\s]*\"\<NULL\>\"[\\s]*lock\-on\-sleep"
    </custom_item>

    <custom_item>
      type        : MACOSX_DEFAULTS_READ
      description : "5.6 Enable OCSP and CRL certificate checking - CRLStyle"
      info        : "A rogue or compromised certificate should not be trsuted"
      solution    : "Run the following commands to enforce the compliant state To set the CRL settings:
defaults write com.apple.security.revocation CRLStyle -string RequireIfPresent
To set the OCSP settings:
defaults write com.apple.security.revocation OCSPStyle -string RequireIfPresent"
      reference   : "800-53|IA-5(2),CSF|PR.AC-1,ITSG-33|IA-5(2),LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/301"
      regex       : "RequireIfPresent"
      plist_item  : "CRLStyle"
      plist_name  : "com.apple.security.revocation"
      plist_user  : "all"
    </custom_item>

    <custom_item>
      type        : MACOSX_DEFAULTS_READ
      description : "5.6 Enable OCSP and CRL certificate checking - OCSPStyle"
      info        : "A rogue or compromised certificate should not be trsuted"
      solution    : "Run the following commands to enforce the compliant state To set the CRL settings:
defaults write com.apple.security.revocation CRLStyle -string RequireIfPresent
To set the OCSP settings:
defaults write com.apple.security.revocation OCSPStyle -string RequireIfPresent"
      reference   : "800-53|IA-5(2),CSF|PR.AC-1,ITSG-33|IA-5(2),LEVEL|2S"
      see_also    : "https://workbench.cisecurity.org/files/301"
      regex       : "RequireIfPresent"
      plist_item  : "OCSPStyle"
      plist_name  : "com.apple.security.revocation"
      plist_user  : "all"
    </custom_item>

    <custom_item>
      type        : BANNER_CHECK
      description : "5.13 Create a Login window banner"
      info        : "An access warning may reduce a casual attacker's tendency to target the system. Access warnings may also aid in the prosecution of an attacker by evincing the attacker's knowledge of the system's private status, acceptable use policy, and authorization requirements."
      solution    : "Place a file named PolicyBanner.txt in/Library/Security/"
      reference   : "800-171|3.1.9,800-53|AC-8,ITSG-33|AC-8,LEVEL|2S,NESA|M1.3.6,NIAv2|AM10a,NIAv2|AM10b,NIAv2|AM10c,NIAv2|AM10d,NIAv2|AM10e,TBA-FIISB|45.2.4"
      see_also    : "https://workbench.cisecurity.org/files/301"
      file        : "/Library/Security/PolicyBanner.txt"
# Note: Variable @BANNER_TEXT@ replaced with "All activities performed on this system will be monitored." in field "content".
      content     : "All activities performed on this system will be monitored."
    </custom_item>

    <custom_item>
      type         : MACOSX_DEFAULTS_READ
      description  : "5.15 Disable Fast User Switching"
      info         : "Fast user switching allows multiple users to run applications simultaneously at console. There can be information disclosed about processes running under a different user. Without a specific configuration to save data and log out users can have unsaved data running in a background session that is not obvious."
      solution     : "In System Preferences: Accounts, Login Options, make sure the 'Enable fast user switching' checkbox is off."
      reference    : "800-53|AC-10,ITSG-33|AC-10,LEVEL|2NS,NESA|T5.5.1"
      see_also     : "https://workbench.cisecurity.org/files/301"
      regex        : "0"
      plist_item   : "MultipleSessionEnabled"
      plist_name   : "/Library/Preferences/.GlobalPreferences"
      plist_option : CANNOT_BE_NULL
    </custom_item>

    <report type:"WARNING">
      description : "5.16 Secure individual keychain and items"
      info        : "Each keychain entry can have different access controls. It's possible to set the keychain item to require a keychain password every time an item is accessed, even if the keychain is unlocked. This level of security could be useful for bank passwords or other passwords that need extra security.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1.	Open Utilities
2.	Select Keychain Access
3.	Double-click keychain
4.	Select Access Control
5.	Check box next to 'Ask for Keychain Password'"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "5.17 Create specialized keychains for different purposes"
      info        : "If the user can logically split password and other entries into different keychains with different passwords, a compromise of one password will have limited effect.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1. Open Utilities
2. Select Keychain Access
3. Select File
4. Select New Keychain
5. Input name of new keychain next to Save As
6. Select Create
7. Drag and drop desired keychain items into new keychain from login keychain"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <custom_item>
      type        : CMD_EXEC
      description : "5.19 Install an approved tokend for smartcard authentication"
      info        : "A tokend is part of mandated smartcard authentication for many organizations.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
      solution    : "Install the appropriate tokend middleware installer for MacOS Forge or third party vendor https://smartcardservices.macosforge.org/."
      reference   : "800-53|IA-5(11),CN-L3|7.1.3.1(f),CSF|PR.AC-1,LEVEL|2S,SWIFT-CSCv1|4.2,SWIFT-CSCv1|5.2"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/bin/ls -l /Library/Security/tokend/ | egrep tokend"
      expect      : ""
      severity    : MEDIUM
    </custom_item>

    <custom_item>
      type        : CMD_EXEC
      description : "6.4 Safari disable Internet Plugins for global use"
      info        : "Allow Internet Plugins only on required sites"
      solution    : "Select either ask to use or blockImpact-Users will have to approve Internet Plugin use by site."
      reference   : "800-171|3.4.6,800-171|3.4.7,800-53|CM-7,CN-L3|7.1.3.5(c),CN-L3|7.1.3.7(d),CN-L3|8.1.4.4(b),CSF|PR.IP-1,CSF|PR.PT-3,ITSG-33|CM-7,LEVEL|2NS,NIAv2|SS13b,NIAv2|SS14a,NIAv2|SS14c,NIAv2|SS15a,SWIFT-CSCv1|2.3"
      see_also    : "https://workbench.cisecurity.org/files/301"
      cmd         : "/usr/bin/defaults read ~/Library/Preferences/com.apple.safari.plist | /usr/bin/grep -i 'PlugInFirstVisitPolicy = *'"
      expect      : ".*= (PlugInPolicyAsk|PlugInPolicyBlock);"
    </custom_item>

    <report type:"WARNING">
      description : "6.5 Use parental controls for systems that are not centrally managed"
      info        : "Limiting usage and restricting features for managed users reduces the risk of the user and/or system being exposed to malicious and/or inappropriate content.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "1.	Open System Preferences
2.	Select Users & Groups
3.	Highlight managed user
4.	Check box next to Enable parental controls
5.	Select Open Parental Controls
6.	Select items within the Parental Controls feature that should be restricted."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.1 Wireless technology on OS X"
      info        : "Some organizations have comprehensive rules that cover the use of wireless technologies in order to implement operational security. There are specific policies governing the use of both Bluetooth and Wi-Fi (802.11) that often include disabling the wireless capability in either software or hardware or both.

Wireless access is part of the feature set required for mobile computers and is considered essential for most users. The general use case for OS X  is to use wireless connectivity, Apple provides a wireless network card and Bluetooth capability in almost every product they make. Bluetooth keyboards are now the default selection where a keyboard is not already integrated into the device.

There are instructions on  how to remove parts of the operating system in order to remediate wireless connectivity but they are not recommended within the scope of this Benchmark.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "https://apple.stackexchange.com/questions/99686/how-to-easily-and-completely-disable-enable-wlan-so-it-cannot-be-turned-on-agai

https://apple.stackexchange.com/questions/123326/disable-bluetooth-permanently

Mac OS X 10.11 computers will not allow this if System Integrity Protection is enabled."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.2 iSight Camera Privacy and Confidentiality Concerns"
      info        : "If the computer is present in an area where there are privacy concerns or sensitive images or actions are taking place the camera should be covered at those times. A permanent cover or alteration may be required when the computer is always located in a confidential area.

Malware is continuously discovered that circumvents the privacy controls of the built-in camera. No computer has perfect security and it seems likely that even if all the drivers are disabled or removed that working drivers can be re-introduced by a determined attacker.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "At this point video chatting and other uses of the built-in camera are standard uses for a computer. It is contrary to a standard use case to permanently remove the camera. In cases where the camera is not allowed to be used at all or when the computer is located in private areas additional precautions are warranted. The General rule should be that if the camera can capture images that could cause embarrassment or an adverse impact the camera should be covered until it is appropriate to use."
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.3 Computer Name Considerations"
      info        : "If the computer is used in an organization that assigns host names, it is a good idea to change the computer name to the host name. This is more of a best practice than a security measure. If the host name and the computer name are the same, computer support may be able to track problems down more easily.

With mobile devices using DHCP IP tracking has serious drawbacks, hostname or computer name tracking makes much more sense for those organizations that can implement it. If the computer is using different names for the 'Computer Name' DNS and Directory environments it can be difficult to manage Macs in an Enterprise asset inventory.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : ""
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.4 Software Inventory Considerations"
      info        : "With the introduction of Mac OS X 10.6.6, Apple added a new application, App Store, which resides in the Applications directory. This application allows a user with admin privileges and an Apple ID to browse Apple's online App Store, purchase (including no cost purchases), and install new applications, bypassing corporate software inventory controls.

Any admin user can install software in the /Applications directory whether from internet downloads, thumb drives, optical media, cloud storage or even binaries through email. Even standard users can run executables if permitted. The source of the software is not nearly as important as a consistent audit of all installed software for patch compliance and appropriateness.

A single user desktop where the user, administrator and the person approving software are all the same person probably does not need to audit software inventory to this extent. It is helpful in the case of stability problems or malware however.

Scan systems on a monthly basis and determine the number of unauthorized pieces of software that are installed. Verify that if an unauthorized piece of software is found one month, it is removed from the system the next.

Export Apple System Profiler information through the built-in or other third party tools on an organizationally defined timetable.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : ""
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.5 Firewall Consideration"
      info        : "In addition to the Application Layer Firewall (alf) mentioned in the benchmark, OSX also ships with packet filter, or pf.

      NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Leveraging pf is beyond the scope of this Benchmark. For more information, please see:

  https://support.apple.com/kb/ht5519

  http://blog.scottlowe.org/2013/05/15/using-pf-on-os-x-mountain-lion/"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.7 App Store Automatically download apps purchased on other Macs Considerations"
      info        : "With 10.9 Apple has expanded the capability of the App Store to automatically download OS X applications that were purchased in the App Store on another Mac. This feature can be very desirable for personal Macs or in a small business setting so that all purchased software through Apple's App Store is provisioned on all OS X Computers, just like iOS. This feature may not be desirable in Corporate environments where the expectations of handling software licenses, tracking software inventory and personal software are different.

Please evaluate your organizations expectations about the use of personal software and software license tracking to align with this setting.
For those organizations that are using Enterprise Apple IDs for their employees the reverse is true. If the user has the username and password for their Apple ID and software is being purchased on that account the user could download the software on other computers they have access to.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : ""
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.8 Extensible Firmware Interface (EFI) password"
      info        : "EFI is the software link between the motherboard hardware and the software operating system. EFI determines which partition or disk to load Mac OS X from, it also determines whether the user can enter single-user mode. The main reasons to set a firmware password have been protections against an alternative boot disk, protection against a passwordless root shell through single user mode and protection against firewire DMA attacks. In the past it was not difficult to reset the firmware password by removing RAM but it did make tampering slightly harder and having to remove RAM remediated memory scraping attacks through DMA. It has always been difficult to Manage the firmware password on OS X computers, though some tools did make it much easier.

Apple patched OS X in 10.7 to mitigate the DMA attacks and the use of FileVault 2 Full-Disk Encryption mitigates the risk of damage to the boot volume if an unauthorized user uses a different boot volume or uses Single User Mode. Apple's reliance on the recovery partition and the additional features it provides make controls that do not allow the user to boot into the recovery partition less attractive.

Starting in Late 2010 with the MacBook Air Apple has slowly updated the requirements to recover from a lost firmware password. Apple only supports taking the computer to an Apple authorized service provider. This change makes managing the firmware password well if used more critical.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : "Setting the firmware password may be good practice in some environments. We cannot recommend it as a standard security practice at this time.

http://support.apple.com/kb/ts3554

https://jamfnation.jamfsoftware.com/article.html?id=58

http://derflounder.wordpress.com/2012/02/05/protecting-yourself-against-firewire-dma-attacks-on-10-7-x/

http://derflounder.wordpress.com/2013/04/26/booting-into-single-user-mode-on-a-filevault-2-encrypted-mac/"
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.9 Apple ID password reset"
      info        : "Apple has a service that will allow a user that has turned it on to reset their login password by signing in to Apple with their Apple ID. This sounds like a service that needs to be explicitly turned off in an Enterprise environment. There are however many factors here.

-	You cannot reset your password if the computer is using FileVault
-	You cannot reset anything but a local account
-	You need physical access to the computer on a network that can phone home to Apple
- The current login keychain will have to be discarded unless the user remembers the old password

The main use case I see for disabling this service is where you are not using FileVault to encrypt the Mac but are using Firmware controls to limit boot options with local accounts. Otherwise the user has other options for resetting a password that are more time consuming but just as effective when they have physical access to the computer.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : ""
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>

    <report type:"WARNING">
      description : "7.11 App Store Password Settings"
      info        : "With OS X 10.11 Apple has added settings for password storage for the App Store in OS X. These settings parallel the settings in iOS. As with iOS the choices are a requirement to provide a password after every purchase or to have a 15 minute grace period, and whether to require a password for free purchases. The response to this setting is stored in a cookie and processed by iCloud.

There is plenty of risk information on the wisdom of this setting for parents with children buying games on iPhones and iPads. the most relevant information here is the likelihood that users that are not authorized to download software may have physical access to an unlocked computer where someone who is authorized recently made a purchase. If that is a concern a password should be required at all times for App Store access in the Password Settings controls

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
      solution    : ""
      reference   : "LEVEL|2NS"
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>
  </then>

  <else>
    <report type:"WARNING">
      description : "Apple OSX 10.11 El Capitan Level 2, version 1.1.0"
      info        : "NOTE: Nessus has not identified that the chosen audit applies to the target device."
      see_also    : "https://workbench.cisecurity.org/files/301"
    </report>
  </else>
</if>

</check_type>
